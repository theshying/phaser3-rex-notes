!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).rexshatterimageplugin=e()}(void 0,function(){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function t(t,e,r){e&&n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1})}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&r(t,e)}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function r(t,e){return(r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");e=t;if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=i(r);return s(this,n?(t=i(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function c(){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=i(t)););return t}(t,e);if(n)return n=Object.getOwnPropertyDescriptor(n,e),n.get?n.get.call(arguments.length<3?t:r):n.value}).apply(this,arguments)}function G(t){for(var e,r,n,i=(i=t.rectangle)?(e=i.x,r=i.y,v=i.width,i.height):(r=e=0,v=t.width,t.height),s=e+v,o=r+i,a=void 0===(c=t.center)?(n=(e+s)/2,(r+o)/2):(n=T(c.x,e,s),T(c.y,r,o)),h=[],u=(h.push([n,a]),I(t,"samplesPerRing",12)),c=I(t,"variation",.25),l=Math.min(v,i),f=1-c,y=1+c,p=0;p<3;p++)j(h,n,a,l*Math.pow(3,p)/27,u,f,y,e,s,r,o);var l=2*Math.max(v,i),c=(j(h,n,a,l,u,f,y,e,s,r,o),I(t,"triangleOutput",!0)),g=h,v=c,d=(void 0===v&&(v=!0),k.triangulate(g));if(v){for(var m=[],b=0,x=d.length;b<x;b+=3){var P=g[d[b+0]],w=g[d[b+1]],O=g[d[b+2]],P=new R(P[0],P[1],w[0],w[1],O[0],O[1]);m.push(P)}return m}return{vertices:g,indices:d}}function j(t,e,r,n,i,s,o,a,h,u,c){for(var l=0;l<i;l++){var f=l/i*p,y=e+Math.cos(f)*n*g(s,o),f=r+Math.sin(f)*n*g(s,o),y=T(y,a,h),f=T(f,u,c);t.push([y,f])}}(function(t){var P;function w(t,e,r,n){var i,s,o,a,h,u,c,l=t[e][0],f=t[e][1],y=t[r][0],p=t[r][1],g=t[n][0],t=t[n][1],v=Math.abs(f-p),d=Math.abs(p-t);if(v<P&&d<P)throw new Error("Eek! Coincident points!");return l=v<P?(o=-(g-y)/(t-p))*((i=(y+l)/2)-(h=(y+g)/2))+(c=(p+t)/2):d<P?(s=-(y-l)/(p-f))*((i=(g+y)/2)-(a=(l+y)/2))+(u=(f+p)/2):(i=((s=-(y-l)/(p-f))*(a=(l+y)/2)-(o=-(g-y)/(t-p))*(h=(y+g)/2)+(c=(p+t)/2)-(u=(f+p)/2))/(s-o),d<v?s*(i-a)+u:o*(i-h)+c),{i:e,j:r,k:n,x:i,y:l,r:(g=y-i)*g+(t=p-l)*t}}P=1/1048576,t.exports={triangulate:function(r,t){var e,n,i,s,o,a,h,u,c,l,f,y=r.length;if(y<3)return[];if(r=r.slice(0),t)for(e=y;e--;)r[e]=r[e][t];for(i=new Array(y),e=y;e--;)i[e]=e;for(i.sort(function(t,e){return r[e][0]-r[t][0]}),s=function(t){for(var e,r,n,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=Number.NEGATIVE_INFINITY,h=t.length;h--;)t[h][0]<i&&(i=t[h][0]),t[h][0]>o&&(o=t[h][0]),t[h][1]<s&&(s=t[h][1]),t[h][1]>a&&(a=t[h][1]);return n=a-s,[[(r=i+.5*(e=o-i))-20*(e=Math.max(e,n)),(n=s+.5*n)-e],[r,n+20*e],[r+20*e,n-e]]}(r),r.push(s[0],s[1],s[2]),o=[w(r,y+0,y+1,y+2)],a=[],h=[],e=i.length;e--;h.length=0){for(f=i[e],n=o.length;n--;)0<(u=r[f][0]-o[n].x)&&u*u>o[n].r?(a.push(o[n]),o.splice(n,1)):u*u+(u=r[f][1]-o[n].y)*u-o[n].r>P||(h.push(o[n].i,o[n].j,o[n].j,o[n].k,o[n].k,o[n].i),o.splice(n,1));m=d=v=g=x=p=b=void 0;for(var p,g,v,d,m,b=h,x=b.length;x;)for(v=b[--x],g=b[--x],p=x;p;)if(m=b[--p],g===(d=b[--p])&&v===m||g===m&&v===d){b.splice(x,2),b.splice(p,2);break}for(n=h.length;n;)l=h[--n],c=h[--n],o.push(w(r,c,l,f))}for(e=o.length;e--;)a.push(o[e]);for(o.length=0,e=a.length;e--;)a[e].i<y&&a[e].j<y&&a[e].k<y&&o.push(a[e].i,a[e].j,a[e].k);return o},contains:function(t,e){if(e[0]<t[0][0]&&e[0]<t[1][0]&&e[0]<t[2][0]||e[0]>t[0][0]&&e[0]>t[1][0]&&e[0]>t[2][0]||e[1]<t[0][1]&&e[1]<t[1][1]&&e[1]<t[2][1]||e[1]>t[0][1]&&e[1]>t[1][1]&&e[1]>t[2][1])return null;var r=t[1][0]-t[0][0],n=t[2][0]-t[0][0],i=t[1][1]-t[0][1],s=t[2][1]-t[0][1],o=r*s-n*i;if(0==o)return null;s=(s*(e[0]-t[0][0])-n*(e[1]-t[0][1]))/o,n=(r*(e[1]-t[0][1])-i*(e[0]-t[0][0]))/o;return s<0||n<0||1<s+n?null:[s,n]}}})(V={exports:{}});var k=V.exports,R=Phaser.Geom.Triangle,I=Phaser.Utils.Objects.GetValue,T=Phaser.Math.Clamp,p=2*Math.PI,g=function(t,e){return t===e?t:t+(e-t)*Math.random()},o=Phaser.Geom.Mesh.Face,l=Phaser.Math.DegToRad,f=Phaser.Math.RadToDeg,y=Phaser.Geom.Mesh.RotateFace,M=function(){e(i,o);var n=u(i);function i(t,e,r){return h(this,i),(t=n.call(this,t,e,r))._rotation=0,t}return t(i,[{key:"rotation",get:function(){return this._rotation},set:function(t){y(this,t-this._rotation),this._rotation=t}},{key:"setRotation",value:function(t){return this.rotation=t,this}},{key:"angle",get:function(){return f(this.rotation)},set:function(t){this.rotation=l(t)}},{key:"setAngle",value:function(t){return this.angle=t,this}},{key:"setAlpha",value:function(t){return this.alpha=t,this}},{key:"tint",get:function(){var t=this.vertex1.color,e=this.vertex2.color,r=this.vertex3.color;return(((t>>0&255)+(e>>0&255)+(r>>0&255))/3<<0)+(((t>>8&255)+(e>>8&255)+(r>>8&255))/3<<8)+(((t>>16&255)+(e>>16&255)+(r>>16&255))/3<<16)},set:function(t){this.vertex1.color=t,this.vertex2.color=t,this.vertex3.color=t}},{key:"setTint",value:function(t){return this.tint=t,this}}]),i}(),S=Phaser.Math.RotateAround,_={x:0,y:0},v=Phaser.GameObjects.Mesh,E=Phaser.Utils.Objects.IsPlainObject,d=Phaser.Utils.Objects.GetValue,U=Phaser.Geom.Mesh.GenerateGridVerts,N=Phaser.Geom.Mesh.Vertex,A=Phaser.Math.Distance.Squared,m=function(){e(a,v);var o=u(a);function a(t,e,r,n,i,s){return h(this,a),E(e)&&(e=d(s=e,"x",0),r=d(s,"y",0),n=d(s,"key",null),i=d(s,"frame",null)),(t=o.call(this,t,e,r,n,i)).type="rexShatterImage",t.hideCCW=!1,t.resetImage(),t.shatterCenter={x:null,y:null},t.setVariation(d(s,"variation",.25)),t.setSamplesPerRing(d(s,"samplesPerRing",12)),t}return t(a,[{key:"setVariation",value:function(t){return this.variation=t,this}},{key:"setSamplesPerRing",value:function(t){return this.samplesPerRing=t,this}},{key:"resetImage",value:function(){return this.setSizeToFrame(),this.clear(),this.dirtyCache[9]=-1,U({mesh:this,texture:this.texture.key,frame:this.frame.name,width:this.frame.cutWidth/this.height,height:this.frame.cutHeight/this.height,flipY:this.frame.source.isRenderTexture}),this.setOrtho(this.width/this.height,1),this}},{key:"shatter",value:function(t,e){var r,n;if(e=void 0===t?(t=this.width/2,this.height/2):(r=t,i=e,p=(f=this).width/2,n=f.height/2,_.x=r-f.x,_.y=i-f.y,_.x/=f.scaleX,_.y/=f.scaleY,S(_,0,0,-f.rotation),_.x+=p,_.y+=n,t=(r=_).x,r.y),this.shatterCenter.x=t,this.shatterCenter.y=e,this.clear(),this.dirtyCache[9]=-1,0!==this.width&&0!==this.height){for(var i=G({width:this.width,height:this.height,center:this.shatterCenter,triangleOutput:!1,variation:this.variation,samplesPerRing:this.samplesPerRing}),s=i.vertices,o=i.indices,a=[],h=this.width,u=this.height,c=this.frame.cutWidth/u/2,l=this.frame.cutHeight/u/2,f=this.frame.source.isRenderTexture,y=this.frame.u0,p=this.frame.u1,g=f?this.frame.v1:this.frame.v0,v=p-y,d=(f?this.frame.v0:this.frame.v1)-g,m=0,b=s.length;m<b;m++){var x=s[m],P=x[0],x=x[1];a.push({g:A(t,e,P,x),x:P/u-c,y:x/u-l,u:y+P/h*v,v:g+x/u*d})}for(m=0,b=o.length;m<b;m+=3){var w=a[o[m+0]],O=a[o[m+1]],j=a[o[m+2]],k=new N(w.x,-w.y,0,w.u,w.v),R=new N(O.x,-O.y,0,O.u,O.v),I=new N(j.x,-j.y,0,j.u,j.v),T=new M(k,R,I);this.vertices.push(k,R,I),this.faces.push(T),T.g=Math.min(w.g,O.g,j.g)}this.faces.sort(function(t,e){return t.g-e.g})}return this}},{key:"startUpdate",value:function(){return this.ignoreDirtyCache=!0,this}},{key:"stopUpdate",value:function(){return this.ignoreDirtyCache=!1,this}},{key:"tint",get:function(){return 0===this.vertices.length?16777215:this.vertices[0].color},set:function(t){for(var e=this.vertices,r=0,n=e.length;r<n;r++)e[r].color=t}},{key:"setTint",value:function(t){return this.tint=t,this}}]),a}();function D(t,e,r,n,i){t=new m(this.scene,t,e,r,n,i);return this.scene.add.existing(t),t}var b=Phaser.Utils.Objects.GetAdvancedValue,F=Phaser.GameObjects.BuildGameObject;function Y(t,e){void 0===t&&(t={}),void 0!==e&&(t.add=e);var e=b(t,"key",null),r=b(t,"frame",null),e=new m(this.scene,0,0,e,r,t);return F(this.scene,e,t),e}var B=Phaser.GameObjects.RenderTexture,W=Phaser.Utils.Objects.IsPlainObject,x=Phaser.Utils.Objects.GetValue,P=function(){e(a,m);var o=u(a);function a(t,e,r,n,i,s){h(this,a),W(e)&&(e=x(s=e,"x",0),r=x(s,"y",0),n=x(s,"width",32),i=x(s,"height",32));n=new B(t,e,r,n,i).setOrigin(.5),i=o.call(this,t,e,r,n.texture.key,null,s);return i.type="rexShatterRenderTexture",i.rt=n,i}return t(a,[{key:"destroy",value:function(t){c(i(a.prototype),"destroy",this).call(this,t),this.rt.destroy(),this.rt=null}}]),a}();function H(t,e,r,n,i){t=new P(this.scene,t,e,r,n,i);return this.scene.add.existing(t),t}var w=Phaser.Utils.Objects.GetAdvancedValue,q=Phaser.GameObjects.BuildGameObject;function z(t,e){void 0===t&&(t={}),void 0!==e&&(t.add=e);var e=w(t,"x",0),r=w(t,"y",0),n=w(t,"width",32),i=w(t,"height",32),e=new P(this.scene,e,r,n,i,t);return q(this.scene,e,t),e}function O(t,e,r,n){if(void 0===n&&(n="."),"object"===a(t)){if(C(e)){if(null==r)return;"object"===a(r)&&(t=r)}else{n=(e="string"==typeof e?e.split(n):e).pop();(function(t,e,r){var n=t;if(!C(e))for(var i,s=0,o=(e="string"==typeof e?e.split("."):e).length;s<o;s++)null!=n[i=e[s]]&&"object"===a(n[i])||(n[i]=s!==o-1||void 0===r?{}:r),n=n[i];return n})(t,e)[n]=r}}}var C=function(t){return null==t||""===t||0===t.length},V=function(){e(n,Phaser.Plugins.BasePlugin);var r=u(n);function n(t){var e;return h(this,n),e=r.call(this,t),t.registerGameObject("rexShatterImage",D,Y),t.registerGameObject("rexShatterRenderTexture",H,z),e}return t(n,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}}]),n}();return O(window,"RexPlugins.GameObjects.ShatterImage",m),O(window,"RexPlugins.GameObjects.ShatterRenderTexture",P),V});
