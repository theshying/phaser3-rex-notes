!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).rexcharactercacheplugin=e()}(void 0,function(){function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function n(t,e,i){e&&r(t.prototype,e),i&&r(t,i),Object.defineProperty(t,"prototype",{writable:!1})}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function a(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");e=t;if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(i){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=s(i);return a(this,r?(t=s(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}var t={setEventEmitter:function(t,e){return void 0===e&&(e=Phaser.Events.EventEmitter),this._privateEE=!0===t||void 0===t,this._eventEmitter=this._privateEE?new e:t,this},destroyEventEmitter:function(){return this._eventEmitter&&this._privateEE&&this._eventEmitter.shutdown(),this},getEventEmitter:function(){return this._eventEmitter},on:function(){return this._eventEmitter&&this._eventEmitter.on.apply(this._eventEmitter,arguments),this},once:function(){return this._eventEmitter&&this._eventEmitter.once.apply(this._eventEmitter,arguments),this},off:function(){return this._eventEmitter&&this._eventEmitter.off.apply(this._eventEmitter,arguments),this},emit:function(t){return this._eventEmitter&&t&&this._eventEmitter.emit.apply(this._eventEmitter,arguments),this},addListener:function(){return this._eventEmitter&&this._eventEmitter.addListener.apply(this._eventEmitter,arguments),this},removeListener:function(){return this._eventEmitter&&this._eventEmitter.removeListener.apply(this._eventEmitter,arguments),this},removeAllListeners:function(){return this._eventEmitter&&this._eventEmitter.removeAllListeners.apply(this._eventEmitter,arguments),this},listenerCount:function(){return this._eventEmitter?this._eventEmitter.listenerCount.apply(this._eventEmitter,arguments):0},listeners:function(){return this._eventEmitter?this._eventEmitter.listeners.apply(this._eventEmitter,arguments):[]},eventNames:function(){return this._eventEmitter?this._eventEmitter.eventNames.apply(this._eventEmitter,arguments):[]}},e={draw:function(t,e,i){var r=this.getFrameIndex(t);if(-1===(r=-1===r?this.getFrameIndex(void 0):r))return console.warn("Does not have free space."),this;var n=this.getTopLeftPosition(r),s={width:this.cellWidth,height:this.cellHeight},o=this.context;return o.save(),o.translate(n.x,n.y),o.clearRect(0,0,s.width,s.height),i?e.call(i,this.canvas,o,s):e(this.canvas,o,s),o.restore(),this.texture.add(t,0,n.x,n.y,s.width,s.height),this.addFrameName(r,t),this},paste:function(t,e){var r=e.canvas;if(!r)return console.warn("Can't get canvas of game object."),this;var i,n,s,e=r.width,o=r.height;return s=e<=this.cellWidth&&o<=this.cellHeight?(n=e,o):(i=Math.max(e/this.cellWidth,o/this.cellHeight),n=e/i,o/i),this.draw(t,function(t,e,i){e.drawImage(r,0,0,n,s),i.width=n,i.height=s}),this},addEmptyFrame:function(t,r,n){return void 0===r&&(r=this.cellWidth),void 0===n&&(n=this.cellHeight),this.draw(t,function(t,e,i){i.width=r,i.height=n}),this},addToBitmapFont:function(){for(var t=this.texture.key,e=this.bitmapFontCache.get(t),i=(e||(e={data:{retroFont:!0,font:t,size:this.cellWidth,lineHeight:this.cellHeight,chars:{}},texture:t,frame:null},this.bitmapFontCache.add(t,e)),e.data.chars),r=this.frameNames,n=0,s=r.length;n<s;n++){var o,a,l,h,c,u=r[n];void 0!==u&&(a=(o=this.texture.get(u)).cutX,l=o.cutY,h=o.cutWidth,c=o.cutHeight,i[u.charCodeAt(0)]={x:a,y:l,width:h,height:c,centerX:a+h/2,centerY:l+c/2,xOffset:0,yOffset:0,xAdvance:h,data:{},kerning:{},u0:o.u0,v0:o.v0,u1:o.u1,v1:o.v1})}return this}},d=Phaser.Utils.Objects.IsPlainObject,p=Phaser.Utils.Objects.GetValue,h=function(){function c(t,e,i,r,n,s,o){var a;u(this,c),d(e)&&(e=p(a=e,"key"),i=p(a,"width"),r=p(a,"height"),n=p(a,"cellWidth"),s=p(a,"cellHeight"),o=p(a,"fillColor")),void 0===n&&(n=64),void 0===s&&(s=64),this.texture=t.sys.textures.createCanvas(e,i=void 0===i?4096:i,r=void 0===r?4096:r),this.canvas=this.texture.getCanvas(),this.context=this.texture.getContext(),this.bitmapFontCache=t.sys.cache.bitmapFont,void 0!==o&&((a=this.context).fillStyle=o,a.fillRect(0,0,this.canvas.width,this.canvas.height)),this.key=e,this.width=i,this.height=r,this.cellWidth=n,this.cellHeight=s,this.columnCount=Math.floor(i/n),this.rowCount=Math.floor(r/s),this.totalCount=this.columnCount*this.rowCount,this.frameNames=Array(this.totalCount);for(var l=0,h=this.frameNames.length;l<h;l++)this.frameNames[l]=void 0}return n(c,[{key:"destroy",value:function(){this.texture=void 0,this.canvas=void 0,this.context=void 0,this.frameNames=void 0,this.bitmapFontCache=void 0}},{key:"getFrameIndex",value:function(t){return this.frameNames.indexOf(t)}},{key:"hasFrameName",value:function(t){return-1!==this.getFrameIndex(t)}},{key:"addFrameName",value:function(t,e){return this.frameNames[t]=e,this}},{key:"isFull",get:function(){return-1===this.getFrameIndex(void 0)}},{key:"getTopLeftPosition",value:function(t,e){void 0===e&&(e={});var i=t%this.columnCount,t=Math.floor(t/this.rowCount);return e.x=i*this.cellWidth,e.y=t*this.cellHeight,e}},{key:"updateTexture",value:function(){return this.texture.refresh(),this}},{key:"remove",value:function(t){var e=this.getFrameIndex(t);return-1!==e&&(this.addFrameName(e,void 0),this.texture.remove(t)),this}},{key:"clear",value:function(){for(var t,e=this.frameNames.length;t<e;t++){var i=this.frameNames[t];void 0!==i&&(this.addFrameName(index,void 0),this.texture.remove(i))}return this}}]),c}(),c=(Object.assign(h.prototype,e),Phaser.Utils.Objects.GetValue),e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};"function"==typeof e.setTimeout&&setTimeout,"function"==typeof e.clearTimeout&&clearTimeout;e=e.performance||{};e.now||e.mozNow||e.msNow||e.oNow||e.webkitNow;new Date;var _="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(t,e){return t(e={exports:{}},e.exports),e.exports}function v(t,e){var i=y(e,"exclude",void 0),r=y(e,"lock",void 0),e=y(e,"freq",!1),n={alive:!0};return void 0!==i&&("string"==typeof i&&(i=i.split()),n.character={$nin:i}),void 0!==r&&(n.lock=r),(e?t.chain().find(n).simplesort("freq",{desc:!0}):t.chain().find(n)).data()}var J=i(function(t,e){function i(t,e){if(this.app="loki",this.options=e||{},void 0!==t&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}function o(t){this.db=null,this.initializeLokiCatalog(t)}t.exports=(i.prototype.closeDatabase=function(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},i.prototype.checkAvailability=function(){return!("undefined"==typeof indexedDB||!indexedDB)},i.prototype.loadKey=i.prototype.loadDatabase=function(e,i){var t=this.app,r=this;null===this.catalog||null===this.catalog.db?this.catalog=new o(function(t){r.catalog=t,r.loadDatabase(e,i)}):this.catalog.getAppKey(t,e,function(t){"function"==typeof i?0===t.id?i(null):i(t.val):console.log(t.val)})},i.prototype.saveKey=i.prototype.saveDatabase=function(e,i,r){var t=this.app,n=this;function s(t){t&&!0===t.success?r(null):r(new Error("Error saving database")),n.options.closeAfterSave&&n.closeDatabase()}null===this.catalog||null===this.catalog.db?this.catalog=new o(function(t){n.saveDatabase(e,i,s)}):this.catalog.setAppKey(t,e,i,s)},i.prototype.deleteKey=i.prototype.deleteDatabase=function(e,i){var t=this.app,r=this;null===this.catalog||null===this.catalog.db?this.catalog=new o(function(t){r.catalog=t,r.deleteDatabase(e,i)}):this.catalog.getAppKey(t,e,function(t){t=t.id;0!==t?r.catalog.deleteAppKey(t,i):"function"==typeof i&&i({success:!0})})},i.prototype.deleteDatabasePartitions=function(e){var i=this;this.getDatabaseList(function(t){t.forEach(function(t){t.startsWith(e)&&i.deleteDatabase(t)})})},i.prototype.getKeyList=i.prototype.getDatabaseList=function(r){var t=this.app,e=this;null===this.catalog||null===this.catalog.db?this.catalog=new o(function(t){e.catalog=t,e.getDatabaseList(r)}):this.catalog.getAppKeys(t,function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].key);"function"==typeof r?r(e):e.forEach(function(t){console.log(t)})})},i.prototype.getCatalogSummary=function(a){this.app;var e=this;null===this.catalog||null===this.catalog.db?this.catalog=new o(function(t){e.catalog=t,e.getCatalogSummary(a)}):this.catalog.getAllKeys(function(t){for(var e,i,r,n,s=[],o=0;o<t.length;o++)i=(e=t[o]).app||"",r=e.key||"",n=e.val||"",i=2*i.length+2*r.length+n.length+1,s.push({app:e.app,key:e.key,size:i});"function"==typeof a?a(s):s.forEach(function(t){console.log(t)})})},o.prototype.initializeLokiCatalog=function(e){var t=indexedDB.open("LokiCatalog",1),i=this;t.onupgradeneeded=function(t){var t=t.target.result;t.objectStoreNames.contains("LokiAKV")&&t.deleteObjectStore("LokiAKV"),t.objectStoreNames.contains("LokiAKV")||((t=t.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0})).createIndex("app","app",{unique:!1}),t.createIndex("key","key",{unique:!1}),t.createIndex("appkey","appkey",{unique:!0}))},t.onsuccess=function(t){i.db=t.target.result,"function"==typeof e&&e(i)},t.onerror=function(t){throw t}},o.prototype.getAppKey=function(t,e,i){var r,n,t=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("appkey").get(t+","+e);t.onsuccess=(r=i,function(t){t=t.target.result;null==t&&(t={id:0,success:!1}),"function"==typeof r?r(t):console.log(t)}),t.onerror=(n=i,function(t){if("function"!=typeof n)throw t;n({id:0,success:!1})})},o.prototype.getAppKeyById=function(t,e,i){var r,n;this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(t).onsuccess=(r=i,n=e,function(t){"function"==typeof n?n(t.target.result,r):console.log(t.target.result)})},o.prototype.setAppKey=function(r,n,s,o){var e,a=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV"),l=a.index("appkey").get(r+","+n);l.onsuccess=function(t){var e,i,t=t.target.result,t=(null==t?t={app:r,key:n,appkey:r+","+n,val:s}:t.val=s,a.put(t));t.onerror=(e=o,function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(l.error))}),t.onsuccess=(i=o,function(t){"function"==typeof i&&i({success:!0})})},l.onerror=(e=o,function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(l.error))})},o.prototype.deleteAppKey=function(t,e){var i,r,n=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV").delete(t);n.onsuccess=(i=e,function(t){"function"==typeof i&&i({success:!0})}),n.onerror=(r=e,function(t){"function"==typeof r?r({success:!1}):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(n.error))})},o.prototype.getAppKeys=function(t,e){var i,r,n,s=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("app"),t=IDBKeyRange.only(t),s=s.openCursor(t);s.onsuccess=(i=[],r=e,function(t){var e,t=t.target.result;t?(e=t.value,i.push(e),t.continue()):"function"==typeof r?r(i):console.log(i)}),s.onerror=(n=e,function(t){"function"==typeof n?n(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(t))})},o.prototype.getAllKeys=function(t){var i,r,e,n=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").openCursor();n.onsuccess=(i=[],r=t,function(t){var e,t=t.target.result;t?(e=t.value,i.push(e),t.continue()):"function"==typeof r?r(i):console.log(i)}),n.onerror=(e=t,function(t){"function"==typeof e&&e(null)})},i)}),W={},f=i(function(t,q){function p(t){var e,i;if(Array.isArray(t)){for(i=0;i<t.length;i++)p(t[i]);o(t)}else if(null!==t&&"object"==typeof t){for(e in t)t.hasOwnProperty(e)&&p(t[e]);o(t)}}function o(t){Object.isFrozen(t)||Object.freeze(t)}function a(t){return Object.isFrozen(t)?d(t,"shallow"):t}function e(t,e){var i,r,n,s;if(t===e)return!0;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=t==t?9:0}switch(e){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=e==e?9:0}if(9!==n||9!==s)return n===s}return i=Number(t),r=Number(e),i==i||r==r?i===r:(i=t.toString())==(r=e.toString())}function i(t,e,i){var r,n,s,o;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}if(9!==s||9!==o)return s===o?i:s<o}return r=Number(t),n=Number(e),r==r&&n==n?r<n||!(n<r)&&i:r==r&&n!=n||(n!=n||r==r)&&(t<e||!(e<t)&&(t==e?i:(r=t.toString())<(n=e.toString())||r==n&&i))}function r(t,e,i){var r,n,s,o;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}if(9!==s||9!==o)return s===o?i:o<s}return r=Number(t),n=Number(e),r==r&&n==n?n<r||!(r<n)&&i:(r!=r||n==n)&&(n==n&&r!=r||(e<t||!(t<e)&&(t==e?i:(r=t.toString(),(n=e.toString())<r||r==n&&i))))}function y(t,e,i){return z.aeq(t,e)?0:z.lt(t,e,!1)?i?1:-1:z.gt(t,e,!1)?i?-1:1:0}function M(t,e,i){for(var r,n,s,o,a=0,l=t.length;a<l;a++)if(o=~(n=(r=t[a])[0]).indexOf(".")?(o=n.split("."),s=$.getIn(e,o,!0),$.getIn(i,o,!0)):(s=e[n],i[n]),0!==(n=y(s,o,r[1])))return n;return 0}function O(t,e,i,r,n,s){var o,a=s||0,s=e[a],l=!1;if("object"==typeof t&&s in t&&(o=t[s]),a+1>=e.length)l=i(o,r,n);else if(Array.isArray(o))for(var h=0,c=o.length;h<c&&!0!==(l=O(o[h],e,i,r,n,a+1));h+=1);else l=O(o,e,i,r,n,a+1);return l}function n(e){return"string"==typeof e||Array.isArray(e)?function(t){return-1!==e.indexOf(t)}:"object"==typeof e&&null!==e?function(t){return j.call(e,t)}:null}function s(t,e,i){for(var r in e)if(j.call(e,r))return F[r](t,e[r],i);return!1}function d(e,t){if(null==e)return null;switch(t||"parse-stringify"){case"parse-stringify":i=JSON.parse(JSON.stringify(e));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},e);break;case"shallow":i=Object.create(e.constructor.prototype),Object.keys(e).map(function(t){i[t]=e[t]});break;case"shallow-assign":i=Object.create(e.constructor.prototype),Object.assign(i,e);break;case"shallow-recurse-objects":var i=d(e,"shallow");Object.keys(e).forEach(function(t){"object"==typeof e[t]&&"Object"===e[t].constructor.name?i[t]=d(e[t],"shallow-recurse-objects"):Array.isArray(e[t])&&(i[t]=T(e[t],"shallow-recurse-objects"))})}return i}function T(t,e){if("parse-stringify"==e)return d(t,e);for(var i=[],r=0,n=t.length;r<n;r++)i[r]=d(t[r],e);return i}function l(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return}}function h(){}function c(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!e||!e.hasOwnProperty("verbose"))&&e.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};e&&e.hasOwnProperty("env")?this.ENV=e.env:this.ENV=_.android||_.NSObject?"NATIVESCRIPT":"undefined"==typeof window||_.window?"NODEJS":"undefined"==typeof document||-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER","undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(e,!0),this.on("init",this.clearChanges)}function u(t){this.hashStore={},this.options=t||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function f(t,e){if(this.mode="reference",this.adapter=null,this.options=e||{},this.dbref=null,this.dbname="",this.pageIterator={},!t)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===t.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=t,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function v(){try{this.fs=W}catch(t){this.fs=null}}function g(){}function m(t,e){return this.collection=t,this.filteredrows=[],this.filterInitialized=!1,this}function x(t,e){if("$regex"===t)Array.isArray(e)?e=new RegExp(e[0],e[1]):e instanceof RegExp||(e=new RegExp(e));else if("object"==typeof e)for(var i in e)"$regex"!==i&&"object"!=typeof e[i]||(e[i]=x(i,e[i]));return e}function b(t,e,i){this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new m(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}function w(t,e){this.name=t,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var a=this,i=((e=e||{}).hasOwnProperty("unique")&&(Array.isArray(e.unique)||(e.unique=[e.unique]),e.unique.forEach(function(t){a.uniqueNames.push(t)})),e.hasOwnProperty("exact")&&e.exact.forEach(function(t){a.constraints.exact[t]=new E(t)}),this.adaptiveBinaryIndices=!e.hasOwnProperty("adaptiveBinaryIndices")||e.adaptiveBinaryIndices,this.transactional=!!e.hasOwnProperty("transactional")&&e.transactional,this.cloneObjects=!!e.hasOwnProperty("clone")&&e.clone,this.cloneMethod=e.hasOwnProperty("cloneMethod")?e.cloneMethod:"parse-stringify",this.asyncListeners=!!e.hasOwnProperty("asyncListeners")&&e.asyncListeners,this.disableMeta=!!e.hasOwnProperty("disableMeta")&&e.disableMeta,this.disableChangesApi=!e.hasOwnProperty("disableChangesApi")||e.disableChangesApi,this.disableDeltaChangesApi=!e.hasOwnProperty("disableDeltaChangesApi")||e.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!e.hasOwnProperty("autoupdate")&&e.autoupdate,this.serializableIndices=!e.hasOwnProperty("serializableIndices")||e.serializableIndices,this.disableFreeze=!e.hasOwnProperty("disableFreeze")||e.disableFreeze,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(e.ttl||-1,e.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[],[]);if(e&&e.indices)if("[object Array]"===Object.prototype.toString.call(e.indices))i=e.indices;else{if("string"!=typeof e.indices)throw new TypeError("Indices needs to be a string or an array of strings");i=[e.indices]}for(var r=0;r<i.length;r++)this.ensureIndex(i[r]);function l(t,e){var i=null!==e&&"object"==typeof e?Object.keys(e):null;if(i&&i.length&&["string","boolean","number"].indexOf(typeof e)<0){for(var r={},n=0;n<i.length;n++){var s,o=i[n];e.hasOwnProperty(o)&&(!t.hasOwnProperty(o)||0<=a.uniqueNames.indexOf(o)||"$loki"==o||"meta"==o?r[o]=e[o]:void 0!==(s=l(t[o],e[o]))&&s!={}&&(r[o]=s))}return 0===Object.keys(r).length?void 0:r}return t===e?void 0:e}function n(){a.changes=[]}this.observerCallback=function(t){var e="function"==typeof Set?new Set:[];e.add||(e.add=function(t){return-1===this.indexOf(t)&&this.push(t),this}),t.forEach(function(t){e.add(t.object)}),e.forEach(function(t){if(!j.call(t,"$loki"))return a.removeAutoUpdateObserver(t);try{a.update(t)}catch(t){}})},this.getChangeDelta=function(t,e){return e?l(e,t):JSON.parse(JSON.stringify(t))},this.getObjectDelta=l,this.getChanges=function(){return a.changes},this.flushChanges=n,this.setChangesApi=function(t){a.disableChangesApi=!t,t||(a.disableDeltaChangesApi=!1)},this.on("delete",function(t){a.disableChangesApi||a.createChange(a.name,"R",t)}),this.on("warning",function(t){a.lokiConsoleWrapper.warn(t)}),n()}function I(t){return-1!==t.indexOf(".")}function B(t){return parseFloat(t,10)}function R(t,e){return t+e}function L(t,e){return t-e}function k(t){return t.reduce(R,0)/t.length}function V(t){var e=k(t),t=k(t.map(function(t){t-=e;return t*t}));return Math.sqrt(t)}function P(t,e,i){if(!1===i)return t[e];for(var r=e.split("."),n=t;0<r.length;)n=n[r.shift()];return n}function C(t,e,i){for(var r,n,s=0,o=t.length;s<o;){if(0===(r=i.apply(null,[e,t[n=s+o>>1]])))return{found:!0,index:n};r<0?o=n:s=1+n}return{found:!1,index:o}}function D(i){return function(t,e){return C(t,e,i)}}function S(){}function A(t){this.field=t,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}function E(t){this.index=Object.create(null),this.field=t}var j,$,z,F,N;t.exports=(j=Object.prototype.hasOwnProperty,$={copyProperties:function(t,e){for(var i in t)e[i]=t[i]},resolveTransformObject:function(t,e,i){var r,n;if("number"!=typeof i&&(i=0),!(10<=++i))for(r in t)"string"==typeof t[r]&&0===t[r].indexOf("[%lktxp]")?(n=t[r].substring(8),e.hasOwnProperty(n)&&(t[r]=e[n])):"object"==typeof t[r]&&(t[r]=$.resolveTransformObject(t[r],e,i));return t},resolveTransformParams:function(t,e){var i,r,n=[];if(void 0===e)return t;for(i=0;i<t.length;i++)r=d(t[i],"shallow-recurse-objects"),n.push($.resolveTransformObject(r,e));return n},getIn:function(t,e,i){if(null!=t){if(!i)return t[e];if("string"==typeof e&&(e=e.split(".")),!Array.isArray(e))throw new Error("path must be a string or array. Found "+typeof e);for(var r=0,n=e.length;null!=t&&r<n;)t=t[e[r++]];return r&&r==n?t:void 0}}},z={aeq:e,lt:i,gt:r},F={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!=e?t==t:t!==e},$dteq:function(t,e){return z.aeq(t,e)},$gt:function(t,e){return z.gt(t,e,!1)},$gte:function(t,e){return z.gt(t,e,!0)},$lt:function(t,e){return z.lt(t,e,!1)},$lte:function(t,e){return z.lt(t,e,!0)},$jgt:function(t,e){return e<t},$jgte:function(t,e){return e<=t},$jlt:function(t,e){return t<e},$jlte:function(t,e){return t<=e},$between:function(t,e){return null!=t&&(z.gt(t,e[0],!0)&&z.lt(t,e[1],!0))},$jbetween:function(t,e){return null!=t&&(t>=e[0]&&t<=e[1])},$in:function(t,e){return-1!==e.indexOf(t)},$inSet:function(t,e){return e.has(t)},$nin:function(t,e){return-1===e.indexOf(t)},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&-1!==t.indexOf(e)},$containsNone:function(t,e){return!F.$containsAny(t,e)},$containsAny:function(t,e){t=n(t);return null!==t&&(Array.isArray(e)?e.some(t):t(e))},$contains:function(t,e){t=n(t);return null!==t&&(Array.isArray(e)?e.every(t):t(e))},$elemMatch:function(t,r){return!!Array.isArray(t)&&t.some(function(i){return Object.keys(r).every(function(t){var e=r[t];return"object"==typeof e&&e||(e={$eq:e}),-1!==t.indexOf(".")?O(i,t.split("."),s,r[t],i):s(i[t],e,i)})})},$type:function(t,e,i){var r=typeof t;return"object"===r&&(Array.isArray(t)?r="array":t instanceof Date&&(r="date")),"object"!=typeof e?r===e:s(r,e,i)},$finite:function(t,e){return e===isFinite(t)},$size:function(t,e,i){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:s(t.length,e,i))},$len:function(t,e,i){return"string"==typeof t&&("object"!=typeof e?t.length===e:s(t.length,e,i))},$where:function(t,e){return!0===e(t)},$not:function(t,e,i){return!s(t,e,i)},$and:function(t,e,i){for(var r=0,n=e.length;r<n;r+=1)if(!s(t,e[r],i))return!1;return!0},$or:function(t,e,i){for(var r=0,n=e.length;r<n;r+=1)if(s(t,e[r],i))return!0;return!1},$exists:function(t,e){return e?void 0!==t:void 0===t}},["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"].forEach(function(t){var r=F[t];F["$"+t]=function(t,e,i){if("string"==typeof e)return r(t,i[e]);if("function"==typeof e)return r(t,e(i));throw new Error("Invalid argument to $$ matcher")}}),N={$eq:F.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0},h.prototype.events={},h.prototype.asyncListeners=!1,h.prototype.on=function(t,e){var i=this;return Array.isArray(t)?t.forEach(function(t){i.on(t,e)}):(this.events[t]||(this.events[t]=[])).push(e),e},h.prototype.emit=function(t){var e,i=this;if(!t||!this.events[t])throw new Error("No event "+t+" defined");this.events[t].length&&(e=Array.prototype.slice.call(arguments,1),this.events[t].forEach(function(t){i.asyncListeners?setTimeout(function(){t.apply(i,e)},1):t.apply(i,e)}))},h.prototype.addListener=h.prototype.on,h.prototype.removeListener=function(t,e){var i=this;Array.isArray(t)?t.forEach(function(t){i.removeListener(t,e)}):this.events[t]&&(t=this.events[t]).splice(t.indexOf(e),1)},((c.prototype=new h).constructor=c).prototype.getIndexedAdapter=function(){return J},c.prototype.configureOptions=function(t,e){var i,r={fs:v,localStorage:g,memory:u};this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==t&&(this.options=t,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof r[t.persistenceMethod]&&(this.persistenceMethod=t.persistenceMethod,this.persistenceAdapter=new r[t.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=t.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),t.autoload&&e&&(i=this,setTimeout(function(){i.loadDatabase(t,t.autoloadCallback)},1)),this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(t,t.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)),this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"}[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new r[this.persistenceMethod]))},c.prototype.copy=function(t){var e,i,r=new c(this.filename,{env:"NA"});if(t=t||{},r.loadJSONObject(this,{retainDirtyFlags:!0}),t.hasOwnProperty("removeNonSerializable")&&!0===t.removeNonSerializable)for(r.autosaveHandle=null,r.persistenceAdapter=null,e=r.collections.length,i=0;i<e;i++)r.collections[i].constraints=null,r.collections[i].ttl=null;return r},c.prototype.addCollection=function(t,e){var i,r=this.collections.length;if(e&&!0===e.disableMeta){if(!1===e.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===e.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof e.ttl&&0<e.ttl)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<r;i+=1)if(this.collections[i].name===t)return this.collections[i];e=new w(t,e);return e.isIncremental=this.isIncremental,this.collections.push(e),this.verbose&&(e.lokiConsoleWrapper=console),e},c.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)},c.prototype.getCollection=function(t){for(var e=this.collections.length,i=0;i<e;i+=1)if(this.collections[i].name===t)return this.collections[i];return this.emit("warning","collection "+t+" not found"),null},c.prototype.renameCollection=function(t,e){t=this.getCollection(t);return t&&(t.name=e),t},c.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},c.prototype.removeCollection=function(t){for(var e=this.collections.length,i=0;i<e;i+=1)if(this.collections[i].name===t){var r,n=new w(t,{}),s=this.collections[i];for(r in s)s.hasOwnProperty(r)&&n.hasOwnProperty(r)&&(s[r]=n[r]);return void this.collections.splice(i,1)}},c.prototype.getName=function(){return this.name},c.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return;case"lokiConsoleWrapper":return null;default:return e}},c.prototype.toJson=c.prototype.serialize=function(t){switch((t=t||{}).hasOwnProperty("serializationMethod")||(t.serializationMethod=this.options.serializationMethod),t.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}},c.prototype.serializeDestructured=function(t){var e,i,r,n,s,o=[];if((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),!0===t.partitioned&&t.hasOwnProperty("partition")&&0<=t.partition)return this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:t.partition});for((s=new c(this.filename)).loadJSONObject(this),e=0;e<s.collections.length;e++)s.collections[e].data=[];if(!0===t.partitioned&&-1===t.partition)return s.serialize({serializationMethod:"normal"});for(o.push(s.serialize({serializationMethod:"normal"})),s=null,e=0;e<this.collections.length;e++)if(r=this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:e}),!1===t.partitioned&&!1===t.delimited){if(!Array.isArray(r))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(n=r.length,i=0;i<n;i++)o.push(r[i]),r[i]=null;o.push("")}else o.push(r);return t.partitioned?(t.delimited,o):t.delimited?(o.push(""),o.join(t.delimiter)):(o.push(""),o)},c.prototype.serializeCollection=function(t){var e,i,r=[];if((t=t||{}).hasOwnProperty("delimited")||(t.delimited=!0),!t.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(e=this.collections[t.collectionIndex].data.length,r=[],i=0;i<e;i++)r.push(JSON.stringify(this.collections[t.collectionIndex].data[i]));return t.delimited?(r.push(""),r.join(t.delimiter)):r},c.prototype.deserializeDestructured=function(t,e){var i,r,n,s=[],o=0,a=1,l=!1;if((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned){if(e.hasOwnProperty("partition"))return-1===e.partition?JSON.parse(t[0]):this.deserializeCollection(t[e.partition+1],e);for(r=(i=JSON.parse(t[0])).collections.length,o=0;o<r;o++)i.collections[o].data=this.deserializeCollection(t[o+1],e)}else{if(e.delimited){if(s=t.split(e.delimiter),t=null,0===s.length)return null}else s=t;for(r=(i=JSON.parse(s[0])).collections.length,s[0]=null;!l;)s[a],""===s[a]?++o>r&&(l=!0):(n=JSON.parse(s[a]),i.collections[o].data.push(n)),s[a++]=null}return i},c.prototype.deserializeCollection=function(t,e){var i,r,n=[];for((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.delimited?(n=t.split(e.delimiter)).pop():n=t,r=n.length,i=0;i<r;i++)n[i]=JSON.parse(n[i]);return n},c.prototype.loadJSON=function(t,e){var i;if(0===t.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(t);break;case"destructured":i=this.deserializeDestructured(t);break;default:i=JSON.parse(t)}this.loadJSONObject(i,e)},c.prototype.loadJSONObject=function(t,e){var i,r,n,s,o,a,l=0,h=t.collections?t.collections.length:0;for(this.name=t.name,t.hasOwnProperty("throttledSaves")&&e&&!e.hasOwnProperty("throttledSaves")&&(this.throttledSaves=t.throttledSaves),this.collections=[];l<h;l+=1){if(i=t.collections[l],(r=this.addCollection(i.name,{disableChangesApi:i.disableChangesApi,disableDeltaChangesApi:i.disableDeltaChangesApi,disableMeta:i.disableMeta,disableFreeze:!i.hasOwnProperty("disableFreeze")||i.disableFreeze})).adaptiveBinaryIndices=!!i.hasOwnProperty("adaptiveBinaryIndices")&&!0===i.adaptiveBinaryIndices,r.transactional=i.transactional,r.asyncListeners=i.asyncListeners,r.cloneObjects=i.cloneObjects,r.cloneMethod=i.cloneMethod||"parse-stringify",r.autoupdate=i.autoupdate,r.changes=i.changes,r.dirtyIds=i.dirtyIds||[],e&&!0===e.retainDirtyFlags?r.dirty=i.dirty:r.dirty=!1,n=i.data.length,s=0,e&&e.hasOwnProperty(i.name))for(o=function(t){var i,r=e[t.name];return r.proto?(i=r.inflate||$.copyProperties,function(t){var e=new r.proto;return i(t,e),e}):r.inflate}(i);s<n;s++)a=o(i.data[s]),r.data[s]=a,r.addAutoUpdateObserver(a),r.disableFreeze||p(r.data[s]);else for(;s<n;s++)r.data[s]=i.data[s],r.addAutoUpdateObserver(r.data[s]),r.disableFreeze||p(r.data[s]);if(r.maxId=void 0===i.maxId?0:i.maxId,void 0!==i.binaryIndices&&(r.binaryIndices=i.binaryIndices),void 0!==i.transforms&&(r.transforms=i.transforms),r.uniqueNames=[],i.hasOwnProperty("uniqueNames")&&(r.uniqueNames=i.uniqueNames),void 0!==i.DynamicViews){for(var c=0;c<i.DynamicViews.length;c++){var u=i.DynamicViews[c],d=r.addDynamicView(u.name,u.options);d.resultdata=u.resultdata,d.resultsdirty=u.resultsdirty,d.filterPipeline=u.filterPipeline,d.sortCriteriaSimple=u.sortCriteriaSimple,d.sortCriteria=u.sortCriteria,d.sortFunction=null,d.sortDirty=u.sortDirty,r.disableFreeze||(p(d.filterPipeline),d.sortCriteriaSimple?p(d.sortCriteriaSimple):d.sortCriteria&&p(d.sortCriteria)),d.resultset.filteredrows=u.resultset.filteredrows,d.resultset.filterInitialized=u.resultset.filterInitialized,d.rematerialize({removeWhereFilters:!0})}t.databaseVersion<1.5&&(r.ensureAllIndexes(!0),r.dirty=!0)}}},c.prototype.close=function(t){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(t),t=void 0)),t&&this.on("close",t),this.emit("close")},c.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],r=t||this.collections.map(e);return this.collections.forEach(function(t){-1!==r.indexOf(e(t))&&(i=i.concat(t.getChanges()))}),i},c.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},c.prototype.clearChanges=function(){this.collections.forEach(function(t){t.flushChanges&&t.flushChanges()})},u.prototype.loadDatabase=function(t,e){var i=this;this.options.asyncResponses?setTimeout(function(){i.hashStore.hasOwnProperty(t)?e(i.hashStore[t].value):e(null)},this.options.asyncTimeout):this.hashStore.hasOwnProperty(t)?e(this.hashStore[t].value):e(null)},u.prototype.saveDatabase=function(t,e,i){var r,n=this;this.options.asyncResponses?setTimeout(function(){r=n.hashStore.hasOwnProperty(t)?n.hashStore[t].savecount:0,n.hashStore[t]={savecount:r+1,lastsave:new Date,value:e},i()},this.options.asyncTimeout):(r=this.hashStore.hasOwnProperty(t)?this.hashStore[t].savecount:0,this.hashStore[t]={savecount:r+1,lastsave:new Date,value:e},i())},u.prototype.deleteDatabase=function(t,e){this.hashStore.hasOwnProperty(t)&&delete this.hashStore[t],"function"==typeof e&&e()},f.prototype.loadDatabase=function(t,i){var r=this;this.dbname=t,this.dbref=new c(t),this.adapter.loadDatabase(t,function(t){var e;t?("string"!=typeof t&&i(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()")),e=JSON.parse(t),r.dbref.loadJSONObject(e),e=null,r.dbref.collections.length,0===r.dbref.collections.length?i(r.dbref):(r.pageIterator={collection:0,pageIndex:0},r.loadNextPartition(0,function(){i(r.dbref)}))):i(t)})},f.prototype.loadNextPartition=function(e,i){var t=this.dbname+"."+e,r=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(i);this.adapter.loadDatabase(t,function(t){t=r.dbref.deserializeCollection(t,{delimited:!0,collectionIndex:e});r.dbref.collections[e].data=t,++e<r.dbref.collections.length?r.loadNextPartition(e,i):i()})},f.prototype.loadNextPage=function(n){var t=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,s=this;this.adapter.loadDatabase(t,function(t){var e,i=t.split(s.options.delimiter),r=i.length,t=(t="")===i[r-1];for(t&&(i.pop(),""===i[(r=i.length)-1]&&1===r&&(i.pop(),r=i.length)),e=0;e<r;e++)s.dbref.collections[s.pageIterator.collection].data.push(JSON.parse(i[e])),i[e]=null;i=[],t?++s.pageIterator.collection<s.dbref.collections.length?s.loadNextPartition(s.pageIterator.collection,n):n():(s.pageIterator.pageIndex++,s.loadNextPage(n))})},f.prototype.exportDatabase=function(t,e,i){var r,n=e.collections.length;for(this.dbref=e,this.dbname=t,this.dirtyPartitions=[-1],r=0;r<n;r++)e.collections[r].dirty&&this.dirtyPartitions.push(r);this.saveNextPartition(function(t){i(t)})},f.prototype.saveNextPartition=function(e){var i=this,t=this.dirtyPartitions.shift(),r=this.dbname+(-1===t?"":"."+t);if(this.options.paging&&-1!==t)return this.pageIterator={collection:t,docIndex:0,pageIndex:0},void this.saveNextPage(function(t){0===i.dirtyPartitions.length?e(t):i.saveNextPartition(e)});t=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:t});this.adapter.saveDatabase(r,t,function(t){t?e(t):0===i.dirtyPartitions.length?e(null):i.saveNextPartition(e)})},f.prototype.saveNextPage=function(e){function t(t){h="",t&&e(t),c?e(null):(r.pageIterator.pageIndex++,r.saveNextPage(e))}var i,r=this,n=this.dbref.collections[this.pageIterator.collection],s=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,o=0,a=n.data.length,l=this.options.delimiter.length,h="",c=!1,u=!1;for(0===n.data.length&&(c=!0);;)if(c||(i=JSON.stringify(n.data[this.pageIterator.docIndex]),h+=i,o+=i.length,++this.pageIterator.docIndex>=a&&(c=!0)),(u=o>=this.options.pageSize?!0:u)&&!c||(h+=this.options.delimiter,o+=l),c||u)return void this.adapter.saveDatabase(s,h,t)},v.prototype.loadDatabase=function(i,r){var n=this;this.fs.stat(i,function(t,e){!t&&e.isFile()?n.fs.readFile(i,{encoding:"utf8"},function(t,e){r(t?new Error(t):e)}):r(null)})},v.prototype.saveDatabase=function(e,t,i){var r=this,n=e+"~";this.fs.writeFile(n,t,function(t){t?i(new Error(t)):r.fs.rename(n,e,i)})},v.prototype.deleteDatabase=function(t,e){this.fs.unlink(t,function(t){t?e(new Error(t)):e()})},g.prototype.loadDatabase=function(t,e){l()?e(localStorage.getItem(t)):e(new Error("localStorage is not available"))},g.prototype.saveDatabase=function(t,e,i){l()?(localStorage.setItem(t,e),i(null)):i(new Error("localStorage is not available"))},g.prototype.deleteDatabase=function(t,e){l()?(localStorage.removeItem(t),e(null)):e(new Error("localStorage is not available"))},c.prototype.throttledSaveDrain=function(t,e){var i=this,r=(new Date).getTime();this.throttledSaves||t(!0),(e=e||{}).hasOwnProperty("recursiveWait")||(e.recursiveWait=!0),e.hasOwnProperty("recursiveWaitLimit")||(e.recursiveWaitLimit=!1),e.hasOwnProperty("recursiveWaitLimitDuration")||(e.recursiveWaitLimitDuration=2e3),e.hasOwnProperty("started")||(e.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending?e.recursiveWait?this.throttledCallbacks.push(function(){i.throttledSavePending?e.recursiveWaitLimit&&r-e.started>e.recursiveWaitLimitDuration?t(!1):i.throttledSaveDrain(t,e):t(!0)}):this.throttledCallbacks.push(t):t(!0)},c.prototype.loadDatabaseInternal=function(i,t){var r=t||function(t,e){if(t)throw t},n=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(t){if("string"==typeof t){var e=!1;try{n.loadJSON(t,i||{}),e=!0}catch(t){r(t)}e&&(r(null),n.emit("loaded","database "+n.filename+" loaded"))}else{if(t)return t instanceof Error?void r(t):"object"==typeof t?(n.loadJSONObject(t,i||{}),r(null),void n.emit("loaded","database "+n.filename+" loaded")):void r("unexpected adapter response : "+t);r(null),void n.emit("loaded","empty database "+n.filename+" loaded")}}):r(new Error("persistenceAdapter not configured"))},c.prototype.loadDatabase=function(e,i){var r=this;this.throttledSaves?this.throttledSaveDrain(function(t){t?(r.throttledSavePending=!0,r.loadDatabaseInternal(e,function(t){0===r.throttledCallbacks.length?r.throttledSavePending=!1:r.saveDatabase(),"function"==typeof i&&i(t)})):"function"==typeof i&&i(new Error("Unable to pause save throttling long enough to read database"))},e):this.loadDatabaseInternal(e,i)},c.prototype.saveDatabaseInternal=function(t){var i,e=t||function(t){if(t)throw t},r=this;this.persistenceAdapter?"incremental"===this.persistenceAdapter.mode?(this.ignoreAutosave=!0,this.persistenceAdapter.saveDatabase(this.filename,function(){var t;{if(r.ignoreAutosave=!1,!i)return t=r.copy({removeNonSerializable:!0}),i=r.collections.map(function(t){return[t.dirty,t.dirtyIds]}),r.collections.forEach(function(t){t.dirty=!1,t.dirtyIds=[]}),t;e(new Error("adapter error - getLokiCopy called more than once"))}},function(t){r.ignoreAutosave=!1,t&&i&&r.collections.forEach(function(t,e){e=i[e];t.dirty=t.dirty||e[0],t.dirtyIds=t.dirtyIds.concat(e[1])}),e(t)})):"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),function(t){r.autosaveClearFlags(),e(t)}):(this.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),function(t){e(t)})):e(new Error("persistenceAdapter not configured"))},c.prototype.save=c.prototype.saveDatabase=function(t){var i,r;this.throttledSaves?this.throttledSavePending?this.throttledCallbacks.push(t):(i=this.throttledCallbacks,this.throttledCallbacks=[],i.unshift(t),this.throttledSavePending=!0,(r=this).saveDatabaseInternal(function(e){r.throttledSavePending=!1,i.forEach(function(t){"function"==typeof t&&setTimeout(function(){t(e)},1)}),0<r.throttledCallbacks.length&&r.saveDatabase()})):this.saveDatabaseInternal(t)},c.prototype.deleteDatabase=function(t,e){var i="function"!=typeof t||e?e||function(t,e){if(t)throw t}:t;null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,function(t){i(t)}):i(new Error("persistenceAdapter not configured"))},c.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},c.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},c.prototype.autosaveEnable=function(t,e){this.autosave=!0;var i=5e3,r=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(i=this.autosaveInterval),this.autosaveHandle=setInterval(function(){r.autosaveDirty()&&!r.ignoreAutosave&&r.saveDatabase(e)},i)},c.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},m.prototype.reset=function(){return 0<this.filteredrows.length&&(this.filteredrows=[]),this.filterInitialized=!1,this},m.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},m.prototype.limit=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new m(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e},m.prototype.offset=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new m(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e},m.prototype.branch=m.prototype.copy=function(){var t=new m(this.collection);return 0<this.filteredrows.length&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t},m.prototype.transform=function(t,e){var i,r,n=this;if("object"!=typeof(t="string"==typeof t&&this.collection.transforms.hasOwnProperty(t)?this.collection.transforms[t]:t)||!Array.isArray(t))throw new Error("Invalid transform");for(void 0!==e&&(t=$.resolveTransformParams(t,e)),i=0;i<t.length;i++)switch((r=t[i]).type){case"find":n.find(r.value);break;case"where":n.where(r.value);break;case"simplesort":n.simplesort(r.property,r.desc||r.options);break;case"compoundsort":n.compoundsort(r.value);break;case"sort":n.sort(r.value);break;case"limit":n=n.limit(r.value);break;case"offset":n=n.offset(r.value);break;case"map":n=n.map(r.value,r.dataOptions);break;case"eqJoin":n=n.eqJoin(r.joinData,r.leftJoinKey,r.rightJoinKey,r.mapFun,r.dataOptions);break;case"mapReduce":n=n.mapReduce(r.mapFunction,r.reduceFunction);break;case"update":n.update(r.value);break;case"remove":n.remove()}return n},m.prototype.sort=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());function e(t,e){return i(r[t],r[e])}var i,r;i=t,r=this.collection.data;return this.filteredrows.sort(e),this},m.prototype.simplesort=function(i,t){var e=10,r=this.collection.data.length,n=this.filteredrows.length,s=this.collection.binaryIndices.hasOwnProperty(i);if(!0===(t=void 0!==t&&!1!==t?t:{desc:!1})&&(t={desc:!0}),0===n){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(i))return this.collection.ensureIndex(i),this.filteredrows=this.collection.binaryIndices[i].values.slice(0),t.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!t.disableIndexIntersect&&s&&(r/n<=(e=t.useJavascriptSorting?6:e)||t.forceIndexIntersect)){for(var o=this.filteredrows,a={},l=0;l<n;l++)a[o[l]]=!0;s=this.collection.binaryIndices[i].values;return this.filteredrows=s.filter(function(t){return a[t]}),t.desc&&this.filteredrows.reverse(),this}if(t.useJavascriptSorting)return this.sort(function(t,e){return t[i]===e[i]?0:t[i]>e[i]?1:t[i]<e[i]?-1:void 0});function h(t,e){return f=~c.indexOf(".")?(f=c.split("."),p=$.getIn(d[t],f,!0),$.getIn(d[e],f,!0)):(p=d[t][c],d[e][c]),y(p,f,u)}var c,u,d,p,f;c=i,u=t.desc,d=this.collection.data;return this.filteredrows.sort(h),this},m.prototype.compoundsort=function(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var e;if(1===t.length)return e=t[0],Array.isArray(e)?this.simplesort(e[0],e[1]):this.simplesort(e,!1);for(var i,r,n=0,s=t.length;n<s;n+=1)e=t[n],Array.isArray(e)||(t[n]=[e,!1]);return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),i=t,r=this.collection.data,this.filteredrows.sort(function(t,e){return M(i,r[t],r[e])}),this},m.prototype.$or=m.prototype.findOr=function(t){var e,i,r,n=0,s=[],o=[];this.count();for(var a=0,l=t.length;a<l;a++)for(i=(e=this.branch().find(t[a]).filteredrows).length,n=0;n<i;n++)void 0===o[r=e[n]]&&(o[r]=!0,s.push(r));return this.filteredrows=s,this.filterInitialized=!0,this},m.prototype.$and=m.prototype.findAnd=function(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this},m.prototype.find=function(t,e){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var i,r,n,s,o,a,l,h=t||"getAll",t=!1,c=[],u=[],d=null;if(e=e||!1,"object"==typeof h){for(i in h)(s={})[i]=h[i],u.push(s),j.call(h,i)&&(n=h[r=i]);if(1<u.length)return this.find({$and:u},e)}if(!r||"getAll"===h)return e&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=0<this.collection.data.length?[0]:[],this.filterInitialized=!0)),this;if("$and"===r||"$or"===r)return this[r](n),e&&1<this.filteredrows.length&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===n||"object"!=typeof n||n instanceof Date)o="$eq",a=n;else{if("object"!=typeof n)throw new Error("Do not know what you want to do.");for(l in n)if(j.call(n,l)){a=n[o=l];break}}"$regex"!==o&&"object"!=typeof a||(a=x(o,a));var p,f,y=-1!==r.indexOf("."),v=(!this.filterInitialized&&this.collection.binaryIndices[r]&&N[o]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(r),t=!0,d=this.collection.binaryIndices[r]),!t&&"$in"===o&&Array.isArray(a)&&"undefined"!=typeof Set&&(a=new Set(a),o="$inSet"),F[o]),g=this.collection.data,m=0,b=0,w=0;if(this.filterInitialized){if(b=(p=this.filteredrows).length,y){for(r=r.split("."),m=0;m<b;m++)if(O(f=g[w=p[m]],r,v,a,f)&&(c.push(w),e))return this.filteredrows=c,this}else for(m=0;m<b;m++)if(v((f=g[w=p[m]])[r],a,f)&&(c.push(w),e))return this.filteredrows=c,this}else if(t){var I=this.collection.calculateRange(o,r,a);if("$in"!==o){for(m=I[0];m<=I[1];m++)if(!0!==N[o]){if(N[o]($.getIn(g[d.values[m]],r,y),a)&&(c.push(d.values[m]),e))return this.filteredrows=c,this.filterInitialized=!0,this}else if(c.push(d.values[m]),e)return this.filteredrows=c,this.filterInitialized=!0,this}else for(m=0,b=I.length;m<b;m++)if(c.push(d.values[I[m]]),e)return this.filteredrows=c,this.filterInitialized=!0,this}else if(b=g.length,y){for(r=r.split("."),m=0;m<b;m++)if(O(f=g[m],r,v,a,f)&&(c.push(m),e))return this.filteredrows=c,this.filterInitialized=!0,this}else for(m=0;m<b;m++)if(v((f=g[m])[r],a,f)&&(c.push(m),e))return this.filteredrows=c,this.filterInitialized=!0,this;return this.filteredrows=c,this.filterInitialized=!0,this},m.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.filterInitialized){for(var r=this.filteredrows.length;r--;)!0===e(this.collection.data[this.filteredrows[r]])&&i.push(this.filteredrows[r]);return this.filteredrows=i,this}for(var n=this.collection.data.length;n--;)!0===e(this.collection.data[n])&&i.push(n);return this.filteredrows=i,this.filterInitialized=!0,this}catch(t){throw t}},m.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},m.prototype.data=function(t){var e,i,r,n=[],s=this.collection.data;if((t=t||{}).removeMeta&&!t.forceClones&&(t.forceClones=!0,t.forceCloneMethod=t.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(t.forceClones=!0,t.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(a=s.length,r=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<a;i++)e=d(s[i],r),t.removeMeta&&(delete e.$loki,delete e.meta),n.push(e);return n}return s.slice()}this.filterInitialized=!0}var o=this.filteredrows,a=o.length;if(this.collection.cloneObjects||t.forceClones)for(r=t.forceCloneMethod||this.collection.cloneMethod,i=0;i<a;i++)e=d(s[o[i]],r),t.removeMeta&&(delete e.$loki,delete e.meta),n.push(e);else for(i=0;i<a;i++)n.push(s[o[i]]);return n},m.prototype.update=function(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var e,i=this.filteredrows.length,r=this.collection.data,n=0;n<i;n++)this.disableFreeze&&!this.collection.cloneObjects&&this.collection.disableDeltaChangesApi?(t(r[this.filteredrows[n]]),this.collection.update(r[this.filteredrows[n]])):(t(e=d(r[this.filteredrows[n]],this.collection.cloneMethod)),this.collection.update(e));return this},m.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},m.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},m.prototype.eqJoin=function(t,e,i,r,n){var s,o,a=[],l=[],h="function"==typeof e,c="function"==typeof i,u={},d=(o=this.data(n)).length;if(t instanceof w)a=t.chain().data(n);else if(t instanceof m)a=t.data(n);else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");a=t}for(var p=a.length,f=0;f<p;f++)u[s=c?i(a[f]):a[f][i]]=a[f];r=r||function(t,e){return{left:t,right:e}};for(var y=0;y<d;y++)s=h?e(o[y]):o[y][e],l.push(r(o[y],u[s]||{}));return this.collection=new w("joinData"),this.collection.insert(l),this.filteredrows=[],this.filterInitialized=!1,this},m.prototype.map=function(t,e){e=this.data(e).map(t);return this.collection=new w("mappedData"),this.collection.insert(e),this.filteredrows=[],this.filterInitialized=!1,this},((b.prototype=new h).constructor=b).prototype.getSort=function(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple},b.prototype.rematerialize=function(t){t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new m(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);var e,i,r,n=Object.isFrozen(this.filterPipeline);if(t.hasOwnProperty("removeWhereFilters"))for(n&&(this.filterPipeline=this.filterPipeline.slice()),i=e=this.filterPipeline.length;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var s=this.filterPipeline;for(this.filterPipeline=[],e=s.length,r=0;r<e;r++)this.applyFind(s[r].val,s[r].uid);return n&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this},b.prototype.branchResultset=function(t,e){var i=this.resultset.branch();return void 0===t?i:i.transform(t,e)},b.prototype.toJSON=function(){var t=new b(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortCriteriaSimple=this.sortCriteriaSimple||null,t.sortDirty=this.sortDirty,t.collection=null,t},b.prototype.removeFilters=function(t){t=t||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;var e=Object.isFrozen(this.filterPipeline),i=0<this.filterPipeline.length;this.filterPipeline=[],e&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,!(this.sortDirty=!1)===t.queueSortPhase&&this.queueSortPhase(),i&&this.emit("filter")},b.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this},b.prototype.applySimpleSort=function(t,e){return this.sortCriteriaSimple={propname:t,options:e||!1},this.collection.disableFreeze||p(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},b.prototype.applySortCriteria=function(t){return this.sortCriteria=t,this.collection.disableFreeze||p(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},b.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},b.prototype.commit=function(){return this.cachedresultset=null,this},b.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},b.prototype._indexOfFilterWithId=function(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1},b.prototype._addFilter=function(t){var e=Object.isFrozen(this.filterPipeline);e&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||p(t),this.filterPipeline.push(t),e&&Object.freeze(this.filterPipeline),this.resultset[t.type](t.val)},b.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline,e=Object.isFrozen(t);this.filterPipeline=[];for(var i=0,r=t.length;i<r;i+=1)this._addFilter(t[i]);return e&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},b.prototype.applyFilter=function(t){var e,i=this._indexOfFilterWithId(t.uid);return 0<=i?((e=Object.isFrozen(this.filterPipeline))&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[i]=t,e&&(o(t),Object.freeze(this.filterPipeline)),this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this)},b.prototype.applyFind=function(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this},b.prototype.applyWhere=function(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this},b.prototype.removeFilter=function(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);t=Object.isFrozen(this.filterPipeline);return t&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(e,1),t&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this},b.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},b.prototype.data=function(t){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(t)},b.prototype.queueRebuildEvent=function(){var t;this.rebuildPending||(this.rebuildPending=!0,t=this,setTimeout(function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))},this.options.minRebuildInterval))},b.prototype.queueSortPhase=function(){var t;this.sortDirty||(this.sortDirty=!0,"active"===(t=this).options.sortPriority?setTimeout(function(){t.performSortPhase()},this.options.minRebuildInterval):this.queueRebuildEvent())},b.prototype.performSortPhase=function(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))},b.prototype.evaluateDocument=function(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var i,r=this.resultset.filteredrows,e=e?-1:r.indexOf(+t),n=r.length,s=new m(this.collection);s.filteredrows=[t],s.filterInitialized=!0;for(var o=0,a=this.filterPipeline.length;o<a;o++)s[(i=this.filterPipeline[o]).type](i.val);var l=0===s.filteredrows.length?-1:0;return-1!==e||-1!=l?-1===e&&-1!=l?(r.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==e&&-1==l?(e<n-1?(r.splice(e,1),this.options.persistent&&this.resultdata.splice(e,1)):(r.length=n-1,this.options.persistent&&(this.resultdata.length=n-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void(-1!==e&&-1!=l&&(this.options.persistent&&(this.resultdata[e]=this.collection.data[t]),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0},b.prototype.removeDocument=function(t){var e,i,r,n={},s={},o=this.resultset,a=this.resultset.filteredrows,l=a.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(i=(t=Array.isArray(t)?t:[t]).length,e=0;e<i;e++)n[t[e]]=!0;for(h=0;h<l;h++)n[a[h]]&&(s[h]=!0);0<Object.keys(s).length&&(this.resultset.filteredrows=this.resultset.filteredrows.filter(function(t,e){return!s[e]}),this.options.persistent&&(this.resultdata=this.resultdata.filter(function(t,e){return!s[e]})),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(var l=o.filteredrows.length,h=0;h<l;h++)r=t.filter(function(e){return function(t){return t<o.filteredrows[e]}}(h)),o.filteredrows[h]-=r.length},b.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(t){throw t}},((w.prototype=new h).contructor=w).prototype.createChange=function(t,e,i,r){this.changes.push({name:t,operation:e,obj:"U"!=e||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(i)):this.getChangeDelta(i,r)})},w.prototype.insertMeta=function(t){var e,i;if(!this.disableMeta&&t)if(Array.isArray(t))for(e=t.length,i=0;i<e;i++)t[i].hasOwnProperty("meta")||(t[i].meta={}),t[i].meta.created=(new Date).getTime(),t[i].meta.revision=0;else t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0},w.prototype.updateMeta=function(t){return!this.disableMeta&&t&&(this.disableFreeze||((t=a(t)).meta=a(t.meta)),t.meta.updated=(new Date).getTime(),t.meta.revision+=1),t},w.prototype.createInsertChange=function(t){this.createChange(this.name,"I",t)},w.prototype.createUpdateChange=function(t,e){this.createChange(this.name,"U",t,e)},w.prototype.insertMetaWithChange=function(t){this.insertMeta(t),this.createInsertChange(t)},w.prototype.updateMetaWithChange=function(t,e,i){return t=this.updateMeta(t,i),this.createUpdateChange(t,e),t},w.prototype.lokiConsoleWrapper={log:function(){},warn:function(){},error:function(){}},w.prototype.addAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},w.prototype.removeAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)},w.prototype.addTransform=function(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e},w.prototype.getTransform=function(t){return this.transforms[t]},w.prototype.setTransform=function(t,e){this.transforms[t]=e},w.prototype.removeTransform=function(t){delete this.transforms[t]},w.prototype.byExample=function(t){var e,i,r=[];for(e in t)t.hasOwnProperty(e)&&r.push(((i={})[e]=t[e],i));return{$and:r}},w.prototype.findObject=function(t){return this.findOne(this.byExample(t))},w.prototype.findObjects=function(t){return this.find(this.byExample(t))},w.prototype.ttlDaemonFuncGen=function(){var t=this,i=this.ttl.age;return function(){var e=Date.now();t.chain().where(function(t){t=t.meta.updated||t.meta.created;return i<e-t}).remove()}},w.prototype.setTTL=function(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))},w.prototype.prepareFullDocIndex=function(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e},w.prototype.configureOptions=function(t){(t=t||{}).hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},w.prototype.ensureIndex=function(t,e){if(void 0===e&&(e=!1),null==t)throw new Error("Attempting to set index without an associated property");var i,r,n,s,o;this.binaryIndices[t]&&!e&&!this.binaryIndices[t].dirty||!0===this.adaptiveBinaryIndices&&this.binaryIndices.hasOwnProperty(t)&&!e||(e={name:t,dirty:!0,values:this.prepareFullDocIndex()},this.binaryIndices[t]=e,i=t,r=this.data,o=!!~i.indexOf(".")&&i.split("."),e.values.sort(function(t,e){if(s=o?(n=$.getIn(r[t],o,!0),$.getIn(r[e],o,!0)):(n=r[t][i],r[e][i]),n!==s){if(z.lt(n,s,!1))return-1;if(z.gt(n,s,!1))return 1}return 0}),e.dirty=!1,this.dirty=!0)},w.prototype.checkAllIndexes=function(t){var e,i=this.binaryIndices,r=[];for(e in i)!j.call(i,e)||this.checkIndex(e,t)||r.push(e);return r},w.prototype.checkIndex=function(t,e){(e=e||{}).randomSamplingFactor&&!1!==e.randomSampling&&(e.randomSampling=!0),e.randomSamplingFactor=e.randomSamplingFactor||.1,(e.randomSamplingFactor<0||1<e.randomSamplingFactor)&&(e.randomSamplingFactor=.1);var i,r,n,s,o,a=!0;if(!this.binaryIndices.hasOwnProperty(t))throw new Error("called checkIndex on property without an index: "+t);if(this.adaptiveBinaryIndices||this.ensureIndex(t),(s=(o=this.binaryIndices[t].values).length)!==this.data.length)return e.repair&&this.ensureIndex(t,!0),!1;if(0===s)return!0;var l=-1!==t.indexOf(".");if(1===s)a=0===o[0];else if(e.randomSampling){if(F.$lte($.getIn(this.data[o[0]],t,l),$.getIn(this.data[o[1]],t,l))||(a=!1),a=F.$lte($.getIn(this.data[o[s-2]],t,l),$.getIn(this.data[o[s-1]],t,l))?a:!1)for(r=Math.floor((s-1)*e.randomSamplingFactor),i=0;i<r-1;i++)if(n=Math.floor(Math.random()*(s-1)),!F.$lte($.getIn(this.data[o[n]],t,l),$.getIn(this.data[o[n+1]],t,l))){a=!1;break}}else for(i=0;i<s-1;i++)if(!F.$lte($.getIn(this.data[o[i]],t,l),$.getIn(this.data[o[i+1]],t,l))){a=!1;break}return!a&&e.repair&&this.ensureIndex(t,!0),a},w.prototype.getBinaryIndexValues=function(t){for(var e=this.binaryIndices[t].values,i=[],r=0;r<e.length;r++)i.push($.getIn(this.data[e[r]],t,!0));return i},w.prototype.getUniqueIndex=function(t,e){var i=this.constraints.unique[t];return!i&&e?this.ensureUniqueIndex(t):i},w.prototype.ensureUniqueIndex=function(t){var e=this.constraints.unique[t];return e||-1==this.uniqueNames.indexOf(t)&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new A(t),this.data.forEach(function(t){e.set(t)}),e},w.prototype.ensureAllIndexes=function(t){var e,i=this.binaryIndices;for(e in i)j.call(i,e)&&this.ensureIndex(e,t)},w.prototype.flagBinaryIndexesDirty=function(){var t,e=this.binaryIndices;for(t in e)j.call(e,t)&&(e[t].dirty=!0)},w.prototype.flagBinaryIndexDirty=function(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)},w.prototype.count=function(t){return(t?this.chain().find(t).filteredrows:this.data).length},w.prototype.ensureId=function(){if(!this.idIndex){for(var t=this.data,e=0,i=t.length,r=new Array(i);e<i;e++)r[e]=t[e].$loki;this.idIndex=r}},w.prototype.ensureIdAsync=function(t){this.async(function(){this.ensureId()},t)},w.prototype.addDynamicView=function(t,e){t=new b(this,t,e);return this.DynamicViews.push(t),t},w.prototype.removeDynamicView=function(e){this.DynamicViews=this.DynamicViews.filter(function(t){return t.name!==e})},w.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},w.prototype.findAndUpdate=function(t,e){"function"==typeof t?this.updateWhere(t,e):this.chain().find(t).update(e)},w.prototype.findAndRemove=function(t){this.chain().find(t).remove()},w.prototype.insert=function(t,e){if(!Array.isArray(t))return this.insertOne(t);var i,r=[],e=e&&!this.cloneObjects&&this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length;e&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",t);for(var n=0,s=t.length;n<s;n++){if(!(i=this.insertOne(t[n],!0)))return;r.push(i)}}finally{e&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",r),1===(r=this.cloneObjects?d(r,this.cloneMethod):r).length?r[0]:r},w.prototype.insertOne=function(t,e){var i=null;if("object"!=typeof t?i=new TypeError("Document needs to be an object"):null===t&&(i=new TypeError("Object cannot be null")),null!==i)throw this.emit("error",i),i;i=this.cloneObjects?d(t,this.cloneMethod):t;if(this.disableFreeze||(i=a(i)),this.disableMeta||(void 0===i.meta?i.meta={revision:0,created:0}:this.disableFreeze||(i.meta=a(i.meta))),e||this.emit("pre-insert",i),this.add(i))return this.disableChangesApi?this.insertMeta(i):this.insertMetaWithChange(i),this.disableFreeze||p(i),t=this.cloneObjects?d(i,this.cloneMethod):i,e||this.emit("insert",t),this.addAutoUpdateObserver(t),t},w.prototype.clear=function(t){var e=this;t=t||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},!0===t.removeIndices?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach(function(t){e.binaryIndices[t].dirty=!1,e.binaryIndices[t].values=[]})},w.prototype.update=function(t){var e,i,r;if(Array.isArray(t)){r=t.length,(e=!this.cloneObjects&&this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length)&&(this.adaptiveBinaryIndices=!1);try{for(i=0;i<r;i+=1)this.update(t[i])}finally{e&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!j.call(t,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var n,s,o,a=this.get(t.$loki,!0),l=this;if(!a)throw new Error("Trying to update a document not in collection.");n=a[0],o=a[1],s=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?d(t,this.cloneMethod):t,this.emit("pre-update",t),this.uniqueNames.forEach(function(t){l.getUniqueIndex(t,!0).update(n,s)}),(this.data[o]=s)!==t&&this.addAutoUpdateObserver(t);for(var h,c,u=0;u<this.DynamicViews.length;u++)this.DynamicViews[u].evaluateDocument(o,!1);if(this.adaptiveBinaryIndices)for(h in this.binaryIndices)this.adaptiveBinaryIndexUpdate(o,h);else this.flagBinaryIndexesDirty();return this.idIndex[o]=s.$loki,this.isIncremental&&this.dirtyIds.push(s.$loki),this.commit(),this.dirty=!0,s=this.disableChangesApi?this.updateMeta(s):this.updateMetaWithChange(s,n),this.disableFreeze||p(s),c=this.cloneObjects?d(s,this.cloneMethod):s,this.emit("update",c,n),c}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}}},w.prototype.add=function(t){if("object"!=typeof t)throw new TypeError("Object being added needs to be an object");if(void 0!==t.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);var e=this.maxId;t.$loki=e,this.disableMeta||(t.meta.version=0);for(var i=0,r=this.uniqueNames.length;i<r;i++)this.getUniqueIndex(this.uniqueNames[i],!0).set(t);this.idIndex&&this.idIndex.push(e),this.isIncremental&&this.dirtyIds.push(e),this.data.push(t);for(var n,s=this.data.length-1,o=this.DynamicViews.length,i=0;i<o;i++)this.DynamicViews[i].evaluateDocument(s,!0);if(this.adaptiveBinaryIndices)for(n in this.binaryIndices)this.adaptiveBinaryIndexInsert(s,n);else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?d(t,this.cloneMethod):t}catch(t){throw this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),t}},w.prototype.updateWhere=function(t,e){var i,r=this.where(t),n=0;try{for(;n<r.length;n++)i=e(r[n]),this.update(i)}catch(t){this.rollback(),this.lokiConsoleWrapper.error(t.message)}},w.prototype.removeWhere=function(t){var e;"function"==typeof t?(e=this.data.filter(t),this.remove(e)):this.chain().find(t).remove()},w.prototype.removeDataOnly=function(){this.remove(this.data.slice())},w.prototype.removeBatchByPositions=function(i){var t,e,r,n,s,o=i.length,a={},l=Object.keys(this.binaryIndices).length,h=Object.keys(this.constraints.unique).length,c=this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length,u=this;try{for(this.startTransaction(),this.ensureId(),r=0;r<o;r++)a[this.idIndex[i[r]]]=!0;if(0<(t=this.DynamicViews.length)||0<l||0<h){if(0<t)for(e=0;e<t;e++)this.DynamicViews[e].removeDocument(i);if(this.adaptiveBinaryIndices&&!c)for(s in this.binaryIndices)this.adaptiveBinaryIndexRemove(i,s);else this.flagBinaryIndexesDirty();h&&this.uniqueNames.forEach(function(t){var e=u.getUniqueIndex(t);if(e)for(r=0;r<o;r++)null!==(n=u.data[i[r]])[t]&&void 0!==n[t]&&e.remove(n[t])})}if(!this.disableChangesApi||1<this.events.delete.length)for(r=0;r<o;r++)this.emit("delete",this.data[i[r]]);if(this.data=this.data.filter(function(t){return!a[t.$loki]}),this.isIncremental)for(r=0;r<o;r++)this.dirtyIds.push(this.idIndex[i[r]]);this.idIndex=this.idIndex.filter(function(t){return!a[t]}),this.adaptiveBinaryIndices&&c&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(t){return this.rollback(),c&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),null}},w.prototype.removeBatch=function(t){for(var e=t.length,i=this.data.length,r={},n=[],s=0;s<i;s++)r[this.data[s].$loki]=s;for(s=0;s<e;s++)"object"==typeof t[s]?n.push(r[t[s].$loki]):n.push(r[t[s]]);this.removeBatchByPositions(n)},w.prototype.remove=function(i){if("object"!=typeof(i="number"==typeof i?this.get(i):i))throw new Error("Parameter is not an object");if(Array.isArray(i))this.removeBatch(i);else{if(!j.call(i,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var t=this.get(i.$loki,!0),e=t[1],r=this;this.uniqueNames.forEach(function(t){var e;null!==i[t]&&void 0!==i[t]&&(e=r.getUniqueIndex(t))&&e.remove(i[t])});for(var n,s=0;s<this.DynamicViews.length;s++)this.DynamicViews[s].removeDocument(e);if(this.adaptiveBinaryIndices)for(n in this.binaryIndices)this.adaptiveBinaryIndexRemove(e,n);else this.flagBinaryIndexesDirty();return this.data.splice(e,1),this.removeAutoUpdateObserver(i),this.idIndex.splice(e,1),this.isIncremental&&this.dirtyIds.push(i.$loki),this.commit(),this.dirty=!0,this.emit("delete",t[0]),delete(i=this.disableFreeze?i:a(i)).$loki,delete i.meta,this.disableFreeze||o(i),i}catch(t){return this.rollback(),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),null}}},w.prototype.get=function(t,e){this.idIndex||this.ensureId();var i,e=e||!1,r=this.idIndex,n=r.length-1,s=0;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;r[s]<r[n];)r[i=s+n>>1]<t?s=1+i:n=i;return n===s&&r[s]===t?e?[this.data[s],s]:this.data[s]:null},w.prototype.getBinaryIndexPosition=function(t,e){var i=$.getIn(this.data[t],e,!0),r=this.binaryIndices[e].values,e=this.calculateRange("$eq",e,i);if(0!==e[0]||-1!==e[1])for(var i=e[0],n=e[1],s=i;s<=n;s++)if(r[s]===t)return s;return null},w.prototype.adaptiveBinaryIndexInsert=function(t,e){var i=-1!==e.indexOf("."),r=this.binaryIndices[e].values,n=$.getIn(this.data[t],e,i),r=(!0===this.serializableIndices&&n instanceof Date&&(this.data[t][e]=n.getTime(),n=$.getIn(this.data[t],e)),0===r.length?0:this.calculateRangeStart(e,n,!0,i));this.binaryIndices[e].values.splice(r,0,t)},w.prototype.adaptiveBinaryIndexUpdate=function(t,e){for(var i=this.binaryIndices[e].values,r=i.length,n=0;n<r&&i[n]!==t;n++);this.binaryIndices[e].values.splice(n,1),this.adaptiveBinaryIndexInsert(t,e)},w.prototype.adaptiveBinaryIndexRemove=function(t,e,i){var r,n,s,o,a,l,h=this.binaryIndices[e],c={};if(Array.isArray(t)){if(1!==(o=t.length)){for(s=0;s<o;s++)c[t[s]]=!0;if(h.values=h.values.filter(function(t){return!c[t]}),!0!==i){var u=t.slice();for(u.sort(function(t,e){return t-e}),r=h.values.length,n=0;n<r;n++){for(a=h.values[n],s=l=0;s<o&&a>u[s];s++)l++;h.values[n]-=l}}return}t=t[0]}if(null===(e=this.getBinaryIndexPosition(t,e)))return null;if(h.values.splice(e,1),!0!==i)for(r=h.values.length,n=0;n<r;n++)h.values[n]>t&&h.values[n]--},w.prototype.calculateRangeStart=function(t,e,i,r){var n,s=this.data,o=this.binaryIndices[t].values,a=0,l=o.length-1;if(0===o.length)return-1;for($.getIn(s[o[a]],t,r),$.getIn(s[o[l]],t,r);a<l;)z.lt($.getIn(s[o[n=a+l>>1]],t,r),e,!1)?a=1+n:l=n;var h=a;return z.aeq(e,$.getIn(s[o[h]],t,r))?h:z.lt(e,$.getIn(s[o[h]],t,r),!1)?i?h:h-1:i?h+1:h},w.prototype.calculateRangeEnd=function(t,e,i){var r,n=this.data,s=this.binaryIndices[t].values,o=0,a=s.length-1;if(0===s.length)return-1;for($.getIn(n[s[o]],t,i),$.getIn(n[s[a]],t,i);o<a;)z.lt(e,$.getIn(n[s[r=o+a>>1]],t,i),!1)?a=r:o=1+r;var l=a;return z.aeq(e,$.getIn(n[s[l]],t,i))?l:z.gt(e,$.getIn(n[s[l]],t,i),!1)?l+1:z.aeq(e,$.getIn(n[s[l-1]],t,i))?l-1:l},w.prototype.calculateRange=function(t,e,i){var r,n,s,o=this.data,a=this.binaryIndices[e].values,l=a.length-1;if(0===o.length)return[0,-1];var h=-1!==e.indexOf("."),c=$.getIn(o[a[0]],e,h),u=$.getIn(o[a[l]],e,h);switch(t){case"$eq":case"$aeq":case"$dteq":if(z.lt(i,c,!1)||z.gt(i,u,!1))return[0,-1];break;case"$gt":if(z.gt(i,u,!0))return[0,-1];if(z.gt(c,i,!1))return[0,l];break;case"$gte":if(z.gt(i,u,!1))return[0,-1];if(z.gt(c,i,!0))return[0,l];break;case"$lt":if(z.lt(i,c,!0))return[0,-1];if(z.lt(u,i,!1))return[0,l];break;case"$lte":if(z.lt(i,c,!1))return[0,-1];if(z.lt(u,i,!0))return[0,l];break;case"$between":return z.gt(i[0],u,!1)?[0,-1]:z.lt(i[1],c,!1)?[0,-1]:((r=this.calculateRangeStart(e,i[0],!1,h))<0&&r++,l<(s=this.calculateRangeEnd(e,i[1],h))&&s--,z.gt($.getIn(o[a[r]],e,h),i[0],!0)||r++,z.lt($.getIn(o[a[s]],e,h),i[1],!0)||s--,s<r?[0,-1]:[r,s]);case"$in":for(var d=[],p=[],f=0,y=i.length;f<y;f++)for(var v=this.calculateRange("$eq",e,i[f]),g=v[0];g<=v[1];g++)void 0===d[g]&&(d[g]=!0,p.push(g));return p}switch(t){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":r=this.calculateRangeStart(e,i,!1,h),n=$.getIn(o[a[r]],e,h)}switch(t){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":s=this.calculateRangeEnd(e,i,h),$.getIn(o[a[s]],e,h)}switch(t){case"$eq":case"$aeq":case"$dteq":return z.aeq(n,i)?[r,s]:[0,-1];case"$gt":return z.aeq($.getIn(o[a[s]],e,h),i)?[s+1,l]:[s,l];case"$gte":return z.aeq($.getIn(o[a[r]],e,h),i)?[r,l]:[r+1,l];case"$lt":return z.aeq($.getIn(o[a[r]],e,h),i)?[0,r-1]:[0,r];case"$lte":return z.aeq($.getIn(o[a[s]],e,h),i)?[0,s]:[0,s-1];default:return[0,o.length-1]}},w.prototype.by=function(e,t){var i;if(void 0===t)return i=this,function(t){return i.by(e,t)};t=this.getUniqueIndex(e,!0).get(t);return this.cloneObjects?d(t,this.cloneMethod):t},w.prototype.findOne=function(t){t=t||{};t=this.chain().find(t,!0).data();return Array.isArray(t)&&0===t.length?null:this.cloneObjects?d(t[0],this.cloneMethod):t[0]},w.prototype.chain=function(t,e){var i=new m(this);return void 0===t?i:i.transform(t,e)},w.prototype.find=function(t){return this.chain().find(t).data()},w.prototype.findOneUnindexed=function(t,e){for(var i=this.data.length;i--;)if($.getIn(this.data[i],t,!0)===e)return this.data[i];return null},w.prototype.startTransaction=function(){if(this.transactional){this.cachedData=d(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},w.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},w.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},w.prototype.async=function(t,e){setTimeout(function(){if("function"!=typeof t)throw new TypeError("Argument passed for async execution is not a function");t(),e()},0)},w.prototype.where=function(t){return this.chain().where(t).data()},w.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(t){throw t}},w.prototype.eqJoin=function(t,e,i,r,n){return new m(this).eqJoin(t,e,i,r,n)},w.prototype.stages={},w.prototype.getStage=function(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]},w.prototype.commitLog=[],w.prototype.stage=function(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i},w.prototype.commitStage=function(t,e){var i,r=this.getStage(t),n=(new Date).getTime();for(i in r)this.update(r[i]),this.commitLog.push({timestamp:n,message:e,data:JSON.parse(JSON.stringify(r[i]))});this.stages[t]={}},w.prototype.no_op=function(){},w.prototype.extract=function(t){for(var e=0,i=this.data.length,r=I(t),n=[];e<i;e+=1)n.push(P(this.data[e],t,r));return n},w.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},w.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},w.prototype.maxRecord=function(t){for(var e,i=0,r=this.data.length,n=I(t),s={index:0,value:void 0};i<r;i+=1)(void 0===e||e<P(this.data[i],t,n))&&(e=P(this.data[i],t,n),s.index=this.data[i].$loki);return s.value=e,s},w.prototype.minRecord=function(t){for(var e,i=0,r=this.data.length,n=I(t),s={index:0,value:void 0};i<r;i+=1)(void 0===e||e>P(this.data[i],t,n))&&(e=P(this.data[i],t,n),s.index=this.data[i].$loki);return s.value=e,s},w.prototype.extractNumerical=function(t){return this.extract(t).map(B).filter(Number).filter(function(t){return!isNaN(t)})},w.prototype.avg=function(t){return k(this.extractNumerical(t))},w.prototype.stdDev=function(t){return V(this.extractNumerical(t))},w.prototype.mode=function(t){var e,i,r,n={};for(i in this.extract(t).forEach(function(t){n[t]?n[t]+=1:n[t]=1}),n)e?e<n[i]&&(r=i):e=n[r=i];return r},w.prototype.median=function(t){var t=this.extractNumerical(t),e=(t.sort(L),Math.floor(t.length/2));return t.length%2?t[e]:(t[e-1]+t[e])/2},S.prototype={keys:[],values:[],sort:function(t,e){return t<e?-1:e<t?1:0},setSort:function(t){this.bs=new D(t)},bs:function(){return new D(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[C(this.keys,t,this.sort).index]}},A.prototype.keyMap={},A.prototype.lokiMap={},A.prototype.set=function(t){var e=t[this.field];if(null!=e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}},A.prototype.get=function(t){return this.keyMap[t]},A.prototype.byId=function(t){return this.keyMap[this.lokiMap[t]]},A.prototype.update=function(t,e){var i;this.lokiMap[t.$loki]!==e[this.field]?(i=this.lokiMap[t.$loki],this.set(e),this.keyMap[i]=void 0):this.keyMap[t[this.field]]=e},A.prototype.remove=function(t){var e=this.keyMap[t];if(null==e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0},A.prototype.clear=function(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)},E.prototype={set:function(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e]},remove:function(t,e){var i,r=this.index[t];for(i in r)r[i]==e&&r.splice(i,1);r.length<1&&(this.index[t]=void 0)},get:function(t){return this.index[t]},clear:function(t){this.index={}}},c.deepFreeze=p,c.freeze=o,c.unFreeze=a,c.LokiOps=F,c.Collection=w,c.DynamicView=b,c.Resultset=m,c.KeyValueStore=S,c.LokiMemoryAdapter=u,c.LokiPartitioningAdapter=f,c.LokiLocalStorageAdapter=g,c.LokiFsAdapter=v,c.persistenceAdapters={fs:v,localStorage:g},c.aeq=e,c.lt=i,c.gt=r,c.Comparators=z,c)}),y=Phaser.Utils.Objects.GetValue,g=function(t){return{character:t,freq:0,alive:!1,lock:!1}},e={load:function(t,e){Array.isArray(t)&&(t=t.join("")),void 0===e&&(e=!1);for(var i,r,n,s=[],o=[],a=this.frameManager.totalCount,l=v(this.characterCollection).length,h=[],c=0,u=t.length;c<u;c++)"\n"!==(y=t.charAt(c))&&(i=this.characterCollection,r=y,(n=void 0)===(n=i.by("character",r))&&(n=g(r),i.insert(n)),p=n,this.freqMode&&p.freq++,p.lock=e,p.alive||(s.push(y),l<a?(p.alive=!0,l++,this.inCacheCount++):h.push(p)),this.characterCollection.update(p));if(0<h.length)for(var d=v(this.characterCollection,{exclude:t,lock:!1,freq:this.freqMode}),c=0,u=h.length;c<u;c++){var p=h[c],f=d.pop();f?(f.alive=!1,this.characterCollection.update(f),p.alive=!0,this.characterCollection.update(p),o.push(f.character)):console.warn("Character cache full, can't add '".concat(p.character,"' character."))}for(c=0,u=o.length;c<u;c++)this.emit("remove",y,this.textObject),this.frameManager.remove(o[c]);for(c=0,u=s.length;c<u;c++){var y=s[c];this.emit("add",y,this.textObject),this.textObject.setText(y),this.frameManager.paste(y,this.textObject)}return 0<s.length&&this.frameManager.updateTexture().addToBitmapFont(),this},unlock:function(){for(var t=this.characterCollection.find({lock:!0}),e=0,i=t.length;e<i;e++)t[e].lock=!1;return this},getAllData:function(){return t=this.characterCollection,(y(e,"freq",!0)?t.chain().simplesort("freq",{desc:!0}):t.chain()).data();var t,e},clear:function(){return this.characterCollection.clear(),this.frameManager.clear().addToBitmapFont(),this}},m=(Object.assign(e,{overrideBitmapText:function(i){var r=this,n=i.setText;return i.setText=function(t,e){return r.load(t,e),n.call(i,t),i},i}}),Phaser.Utils.Objects.GetValue),b=function(){function a(t,e){u(this,a);var i,r,n,s=m(e,"eventEmitter",void 0),o=m(e,"EventEmitterClass",void 0),s=(this.setEventEmitter(s,o),this.freqMode=m(e,"freqMode",!0),this.frameManager=(s=t,t=c(o=e,"key"),i=c(o,"cellWidth",32),r=c(o,"cellHeight",32),o=c(o,"maxCharacterCount",4096),o=Math.ceil(Math.sqrt(o)),new h(s,t,i*o,r*o,i,r)),this.frameManager.addToBitmapFont(),this.key=this.frameManager.key,this.cellWidth=this.frameManager.cellWidth,this.cellHeight=this.frameManager.cellHeight,this.characterCollection=(n=void 0===n?new f("characters.db",{env:"BROWSER"}):n).addCollection("characters",{disableMeta:!0,unique:["character"],indices:["character","freq","alive","lock"]}),m(e,"textObject"));s&&this.bindTextObject(s),this.inCacheCount=0,this.load(m(e,"content",""))}return n(a,[{key:"shutdown",value:function(){this.destroyEventEmitter(),this.frameManager.destroy(),this.characterCollection=void 0,this.textObject&&this.textObject.destroy()}},{key:"destroy",value:function(){this.shutdown()}},{key:"bindTextObject",value:function(t){return this.textObject=t,this}}]),a}();return Object.assign(b.prototype,t,e),function(t){var e=r;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t);var i=l(r);function r(t){return u(this,r),i.call(this,t)}return n(r,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"add",value:function(t,e){return new b(t,e)}}]),r}(Phaser.Plugins.BasePlugin)});
