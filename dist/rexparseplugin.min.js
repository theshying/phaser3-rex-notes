!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rexparseplugin=t()}(void 0,function(){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function e(e,t,r){t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1})}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&r(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");t=e;if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function c(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=s(r);return u(this,n?(e=s(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function l(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function f(n){return this.addFile(new A(this,{config:{callback:function(e,t){return b(r=void 0===(r=n)?I:r).then(function(){setTimeout(e,0)}).catch(t);var r}}})),this}function d(e,t,r){if(e&&"number"!=typeof e){if(e.hasOwnProperty(t))return e[t];if(-1===t.indexOf("."))return r;for(var n=t.split("."),i=e,o=r,s=0;s<n.length;s++){if(!i.hasOwnProperty(n[s])){o=r;break}o=i[n[s]],i=i[n[s]]}return o}return r}function y(e,t,r){var n=[];return x({query:e,startIndex:t,totalLines:r,forEachPageCallback:function(e){n.push.apply(n,l(e))},resolveCallback:function(){return n}})}function t(e,t,r,n){if(void 0===n&&(n="."),"object"===a(e)){if(O(t)){if(null==r)return;"object"===a(r)&&(e=r)}else{n=(t="string"==typeof t?t.split(n):t).pop();(function(e,t,r){var n=e;if(!O(t))for(var i,o=0,s=(t="string"==typeof t?t.split("."):t).length;o<s;o++)null!=n[i=t[o]]&&"object"===a(n[i])||(n[i]=o!==s-1||void 0===r?{}:r),n=n[i];return n})(e,t)[n]=r}}}function g(e){return e.select("id"),y(e).then(function(e){return 0===e.length?Promise.resolve():Parse.Object.destroyAll(e)})}function m(e,t,r){return(r=r||new t).set(e),r}function p(e,t,r){var n;(t||r)&&(n=Parse.User.current())&&(n=new Parse.ACL(n),r||n.setPublicWriteAccess(!0),t||n.setPublicReadAccess(!0),e.setACL(n))}function v(e){var t=(e=e?new Date(e):new Date).getFullYear(),r=e.getMonth()+1,n=e.getDate(),i=new Date(e.getFullYear(),0,1),e=Math.ceil(((e-i)/864e5+i.getDay()+1)/7);return{d:"".concat(t,"-").concat(r,"-").concat(n),w:"".concat(t,"-").concat(e),m:"".concat(t,"-").concat(r),y:"".concat(t)}}function P(e,t){var r=new Parse.User;return r.set("username",e).set("password",t),r.signUp().then(function(){return Parse.User.logIn(e,t)})}var b=function(a){return new Promise(function(e,t){for(var r=a,n=e,i=document.getElementsByTagName("script"),o=0,s=i.length;o<s;o++)if(-1!=i[o].src.indexOf(r))return void(n&&n());e=document.createElement("script");e.setAttribute("src",r),n&&(e.onload=n),document.head.appendChild(e)})},I="https://npmcdn.com/parse@".concat("2.11.0","/dist/parse.min.js"),w=Phaser.Loader.FILE_POPULATED,k=Phaser.Utils.String.UUID,A=function(){o(n,Phaser.Loader.File);var r=c(n);function n(e,t){return i(this,n),t.hasOwnProperty("type")||(t.type="await"),t.hasOwnProperty("url")||(t.url=""),t.hasOwnProperty("key")||(t.key=k()),r.call(this,e,t)}return e(n,[{key:"load",value:function(){var e,t,r,n;this.state===w?this.loader.nextFile(this,!0):(e=(t=this.config).callback,t=t.scope,r=this.onLoad.bind(this),n=this.onError.bind(this),e?t?e.call(t,r,n):e(r,n):this.onLoad())}},{key:"onLoad",value:function(){this.loader.nextFile(this,!0)}},{key:"onError",value:function(){this.loader.nextFile(this,!1)}}]),n}(),C=function(){function r(){i(this,r)}return e(r,[{key:"initializeApp",value:function(e){return firebase.initializeApp(e),this}}],[{key:"register",value:function(e,t){r.prototype[e]=t}}]),r}(),x=function(e){return void 0===e.startIndex&&(e.startIndex=0),void 0===e.totalLines&&(e.totalLines=1/0),void 0===e.linesPerPage&&(e.linesPerPage=1e3),e.remainderLines=e.totalLines,S(e)},S=function n(i){var e=i.query,o=Math.min(i.remainderLines,i.linesPerPage);return i.remainderLines-=o,e.skip(i.startIndex).limit(o).find().then(function(e){var t,r=0===i.remainderLines||e.length<o;return i.forEachPageCallback&&(r|=!!i.forEachPageCallback(e)),r?(i.resolveCallback&&(t=i.resolveCallback()),Promise.resolve(t)):(i.startIndex+=e.length,n(i))})},Q={loadItems:function(t,r){void 0===t&&(t=0),void 0===r&&(r=1/0),this.items.length=0;var n=this;return y(this.query,t,r).then(function(e){return n.items=e,n.startIndex=t,n.pageIndex=Math.floor(t/n.itemCount),n.isFullPage=r===1/0||r===e.length,Promise.resolve(e)}).catch(function(e){return n.isFullPage=!1,Promise.reject(e)})},loadPage:function(e){e*=this.itemCount;return this.loadItems(e,this.itemCount)},loadFirstPage:function(){return this.loadItems(0,this.itemCount)},loadCurrentPage:function(){return this.loadItems(this.startIndex,this.itemCount)},loadNextPage:function(){var e=this.startIndex+this.itemCount;return this.loadItems(e,this.itemCount)},loadPreviousPage:function(){var e=this.startIndex-this.itemCount;return this.loadItems(e,this.itemCount)}},F=function(){function t(e){i(this,t),this.items=[],this.startIndex=0,this.pageIndex=0,this.isFullPage=!1,this.setItemCount(d(e,"itemCount",100)),this.setQuery(d(e,"query",void 0))}return e(t,[{key:"setItemCount",value:function(e){return this.itemCount=e,this.pageIndex=Math.floor(this.startIndex/e),this}},{key:"setQuery",value:function(e){return this.query=e,this}},{key:"getItem",value:function(e){return this.items[e-this.startIndex]}},{key:"findFirst",value:function(e,t){for(var r,n=this.items.length;r<n;r++)if(this.items[r].get(e)===t)return r+this.startIndex;return-1}}]),t}(),O=(Object.assign(F.prototype,Q),function(e){return null==e||""===e||0===e.length}),Q=(C.register("pageLoader",function(e){return new F(e)}),t(window,"RexPlugins.Parse.PageLoader",F),{loadItem:function(e,t){var r;return"string"==typeof e?(r=this.baseQuery,(r=t?r.select(t):r).get(e)):(r=this.getQuery(e).limit(1),(r=t?r.select(t):r).find().then(function(e){return Promise.resolve(e[0])}))},loadPage:function(e){return this.pageLoader.loadPage(e)},loadCurrentPage:function(){return this.pageLoader.loadCurrentPage()},loadNextPage:function(){return this.pageLoader.loadNextPage()},loadPreviousPage:function(){return this.pageLoader.loadPreviousPage()},loadItems:function(e,t){return this.pageLoader.loadItems(e,t)},load:function(e){return void 0===e&&(e=this.baseQuery),y(e)},loadRandomItems:function(a,u){"number"==typeof a&&(u=a,a=void 0),void 0===a&&(a=this.baseQuery),void 0===u&&(u=1),a.select("id");var c=this;return y(a).then(function(e){for(var t=e,r=t.length-1;0<r;r--){var n=Math.floor(Math.random()*(r+1)),i=t[r];t[r]=t[n],t[n]=i}u=Math.min(u,e.length);for(var o=[],s=0;s<u;s++)o.push(e[s].id);return a=c.baseQuery.containedIn("objectId",o),y(a)})}}),D={deleteItem:function(e){return this.createItem().set("id",e).destroy()},delete:function(e){return void 0===e&&(e=this.baseQuery),g(e)}},L=function(){function r(e){i(this,r),this.pageLoader=new F,this.setClassName(d(e,"className","Item")),this.setItemCount(d(e,"itemCount",100)),this.setQuery(),this.primaryKeys=[];var t=d(e,"primaryKeys",void 0);t&&this.setPrimaryKey(t),this.setOwnerReadMode(d(e,"ownerRead",void 0)),this.setOwnerWriteMode(d(e,"ownerWrite",void 0))}return e(r,[{key:"setClassName",value:function(e){return this.customClass=Parse.Object.extend(e),this}},{key:"setPrimaryKey",value:function(e){if(e)if("string"==typeof e)this.primaryKeys.length=1,this.primaryKeys[0]=e;else{var t=this.primaryKeys,r=e,n=void 0,e=void 0;void 0===e&&(e=r.length),t.length=e-(n=void 0===n?0:n);for(var i=0,o=t.length;i<o;i++)t[i]=r[i+n]}else this.primaryKeys.length=0;return this}},{key:"setOwnerReadMode",value:function(e){return this.ownerRead=e,this}},{key:"setOwnerWriteMode",value:function(e){return this.ownerWrite=e,this}},{key:"createItem",value:function(){return new this.customClass}},{key:"setItemCount",value:function(e){return this.pageLoader.setItemCount(e),this}},{key:"setQuery",value:function(e){return void 0===e&&(e=this.baseQuery),this.pageLoader.setQuery(e),this}},{key:"baseQuery",get:function(){return new Parse.Query(this.customClass)}},{key:"startIndex",get:function(){return this.pageLoader.startIndex}},{key:"pageIndex",get:function(){return this.pageLoader.pageIndex}},{key:"isLastPage",get:function(){return this.pageLoader.isLastPage}}]),r}(),j=(Object.assign(L.prototype,Q,D,{getQuery:function(e){for(var t,r,n=this.baseQuery,i=e instanceof this.customClass,o=0,s=this.primaryKeys.length;o<s;o++)t=this.primaryKeys[o],r=i?e.get(t):e[t],n.equalTo(t,r);return n},save:function(r){if("[object Array]"===Object.prototype.toString.call(r))return this.saveItems(r);var n=this;return new Promise(function(e,t){if(!(0<n.primaryKeys.length))return e();n.loadItem(r,"id").then(e,t)}).then(function(e){return e=m(r,n.customClass,e),p(e,n.ownerRead,n.ownerWrite),e.save()})},saveItems:function(u){var c=this;return new Promise(function(e,t){var r=[];if(!(0<c.primaryKeys.length)){for(s=0,a=u.length;s<a;s++){var n=m(u[s],c.customClass);p(n,c.ownerRead,c.ownerWrite),r.push(n)}return e(r)}for(var i,o=[],s=0,a=u.length;s<a;s++)!function(){var t=u[s];i=c.loadItem(t,"id").then(function(e){e=m(t,c.customClass,e),p(e,c.ownerRead,c.ownerWrite),r.push(e)}),o.push(i)}();Promise.all(o).then(function(){return e(r)}).catch(t)}).then(function(e){return Parse.Object.saveAll(e)})},getItemCount:function(e){return(e=void 0===e?this.baseQuery:e).count()}}),C.register("itemTable",function(e){return new L(e)}),t(window,"RexPlugins.Parse.ItemTable",L),{d:"tagD",w:"tagW",m:"tagM",y:"tagY"}),T={d:"scoreD",w:"scoreW",m:"scoreM",y:"scoreY"},Q={loadFirstPage:function(){this.resetPageQuery();var t=this;return this.page.loadFirstPage().then(function(e){return Promise.resolve(R.call(t,e))})},loadNextPage:function(){this.resetPageQuery();var t=this;return this.page.loadNextPage().then(function(e){return Promise.resolve(R.call(t,e))})},loadPreviousPage:function(){this.resetPageQuery();var t=this;return this.page.loadPreviousPage().then(function(e){return Promise.resolve(R.call(t,e))})},loadCurrentPage:function(){this.resetPageQuery();var t=this;return this.page.loadCurrentPage().then(function(e){return Promise.resolve(R.call(t,e))})},load:function(e,t){this.resetPageQuery();var r=this;return this.page.load(e,t).then(function(e){return Promise.resolve(R.call(r,e))})},resetPageQuery:function(){return this.resetQueryFlag&&(this.resetQueryFlag=!1,this.page.setQuery(this.getPageQuery())),this}},R=function(e){for(var t,r=[],n=T[this.timeFilterType[0]],i=0,o=e.length;i<o;i++){if(t=e[i].toJSON(),!1!==this.timeFilters)for(var s in t.score=t[n],this.timeFilters)delete t[j[s]],delete t[T[s]];r.push(t)}return r},D={deleteUser:function(e){void 0===e&&(e=this.userID);e=this.getRecordQuery(void 0,void 0,e,void 0);return g(e)},deleteBoard:function(e,t){void 0===e&&(e=this.boardID),void 0===t&&(t=this.tag);e=this.getRecordQuery(e,t,void 0,void 0);return g(e)}},N={getRecordQuery:function(e,t,r,n){var i=this.baseQuery,i=void 0!==e?i.equalTo("boardID",e):i;return i=void 0!==t?i.equalTo("tag",t):i,i=void 0!==r?i.equalTo("userID",r):i,i=void 0!==n?i.equalTo(n[0],n[1]):i},getMyRecordQuery:function(e){return void 0===e&&(e=this.userID),this.getRecordQuery(this.boardID,this.tag,e,void 0).limit(1)},getPageQuery:function(){var e,t;return t=!1!==this.timeFilters?(t=this.timeFilterType[0],e=[j[t],v()[t]],T[t]):(e=void 0,"score"),this.getRecordQuery(this.boardID,this.tag,void 0,e).descending(t)}},M=function(){function t(e){i(this,t),this.setClassName(d(e,"className","Item")),this.userInfo={userID:void 0,userName:void 0},this.setUser(d(e,"userID",""),d(e,"userName",void 0)),this.setBoardID(d(e,"boardID",void 0)),this.setTag(d(e,"tag",void 0)),this.setTimeFilters(d(e,"timeFilters",!1)),this.setTimeFilterType(d(e,"timeFilterType","year")),this.page=new F({itemCount:d(e,"pageItemCount",100)}),this.resetQueryFlag=!0}return e(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setClassName",value:function(e){return this.resetQueryFlag=!0,this.customClass=Parse.Object.extend(e),this}},{key:"setUser",value:function(e,t){return!function(e){if("object"!==a(e)||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!{}.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0}(e)?(this.userID=e,this.userName=t):this.userInfo=e,this}},{key:"setBoardID",value:function(e){return this.resetQueryFlag|=this.boardID!==e,this.boardID=e,this}},{key:"setTag",value:function(e){return this.resetQueryFlag|=this.tag!==e,this.tag=e,this}},{key:"setTimeFilters",value:function(e){return this.timeFilters=!1!==e&&{d:d(e,"day",!0),w:d(e,"week",!0),m:d(e,"month",!0),y:d(e,"year",!0)},this}},{key:"setTimeFilterType",value:function(e){return this.resetQueryFlag|=this.timeFilterType!==e,this.timeFilterType=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"baseQuery",get:function(){return new Parse.Query(this.customClass)}},{key:"pageIndex",get:function(){return this.page.pageIndex}},{key:"isFirstPage",get:function(){return 0===this.page.pageIndex}},{key:"isLastPage",get:function(){return!1===this.page.isFullPage}}]),t}(),N=(Object.assign(M.prototype,{post:function(e,t,r){var i={userID:this.userID},n=(void 0!==this.boardID&&(i.boardID=this.boardID),this.userName&&(i.userName=this.userName),v(r));if(!1!==this.timeFilters)for(var o in this.timeFilters)this.timeFilters[o]&&(i[j[o]]=n[o],i[T[o]]=e);else i.score=e;this.tag&&(i.tag=this.tag),t&&Object.assign(i,t);var n=v(),s=this;return this.getMyRecordQuery().find().then(function(e){var t,r=e[0];if(r)if(!1!==s.timeFilters)for(var n in s.timeFilters)s.timeFilters[n]&&(r.get(t=j[n])===i[t]&&(i[t=T[n]]=Math.max(r.get(t),i[t])));else i.score=Math.max(r.get("score"),i.score);return m(i,s.customClass,r).save()})},getScore:function(e){return this.getMyRecordQuery(e).find().then(function(e){e=(e=e[0])&&e.toJSON();return Promise.resolve(e)})},getRank:function(t){void 0===t&&(t=this.userID);var i,o,s,e=this.getPageQuery();return i=function(e){return e.get("userID")===t},o={item:void 0,index:void 0},s=0,x({query:e,forEachPageCallback:function(e){for(var t,r=0,n=e.length;r<n;r++)if(t=e[r],i(t))return o.item=t,o.index=s+r,!0;s+=e.length},resolveCallback:function(){return o}}).then(function(e){return Promise.resolve({userID:t,rank:e.index})})}},N,Q,D),C.register("leaderBoard",function(e){return new M(e)}),t(window,"RexPlugins.Parse.Leaderboard",M),function(){o(r,Phaser.Plugins.BasePlugin);var t=c(r);function r(e){return i(this,r),(e=t.call(this,e)).add=new C,e}return e(r,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"preload",value:function(e,t){return f.call(e.sys.load,t),this}}]),r}());return Object.assign(N.prototype,{quickLogin:function(e,t){return Parse.User.logOut().then(function(){return Parse.User.logIn(e,t)}).catch(function(){return P(e,t)})}}),N});
